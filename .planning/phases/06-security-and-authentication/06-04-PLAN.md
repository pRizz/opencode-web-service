---
phase: 06-security-and-authentication
plan: 04
type: execute
wave: 3
depends_on: ["06-02", "06-03"]
files_modified:
  - packages/cli-rust/src/commands/status.rs
  - packages/cli-rust/src/wizard/auth.rs
  - packages/cli-rust/src/wizard/mod.rs
  - packages/cli-rust/src/commands/start.rs
autonomous: true

must_haves:
  truths:
    - "occ status displays Security section with binding, auth, and warnings"
    - "Setup wizard creates first user in container via PAM flow"
    - "User list is displayed in status output"
    - "First start without users is blocked unless opted out"
  artifacts:
    - path: "packages/cli-rust/src/commands/status.rs"
      provides: "Status with Security section"
      contains: "Security:"
    - path: "packages/cli-rust/src/wizard/auth.rs"
      provides: "Wizard creates container user"
      contains: "create_user"
    - path: "packages/cli-rust/src/commands/start.rs"
      provides: "First-start security gate"
      contains: "Security not configured"
  key_links:
    - from: "packages/cli-rust/src/commands/status.rs"
      to: "config.bind_address"
      via: "Config load and display"
      pattern: "config\\.bind_address"
    - from: "packages/cli-rust/src/wizard/auth.rs"
      to: "opencode_cloud_core::docker::users"
      via: "create_user call"
      pattern: "create_user"
---

<objective>
Enhance status display with Security section and update wizard to create container users via PAM.

Purpose: Make security configuration visible at a glance (SECU-03 status requirement) and integrate PAM user creation into the setup wizard (SECU-01 requirement for basic auth).

Output: occ status shows Security section with binding, auth status, user list; wizard creates users in container with random or prompted password; first start blocked without security configured.

Note: /health endpoint is deferred to Phase 7 (Update and Maintenance) per ROADMAP.md.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-security-and-authentication/06-CONTEXT.md
@.planning/phases/06-security-and-authentication/06-RESEARCH.md
@packages/cli-rust/src/commands/status.rs
@packages/cli-rust/src/wizard/auth.rs
@packages/cli-rust/src/wizard/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Security section to status command</name>
  <files>packages/cli-rust/src/commands/status.rs</files>
  <action>
Add a dedicated "Security" section to status output after the existing info:

1. Load config at beginning if not already loaded:
   ```rust
   let config = opencode_cloud_core::config::load_config().ok();
   ```

2. After the existing status output (Installed: line), add Security section:
   ```

   Security
   --------
   Binding:     127.0.0.1 [LOCAL ONLY]  // or 0.0.0.0 [NETWORK EXPOSED]
   Auth users:  admin, dev  // or "None configured" in yellow
   Trust proxy: no  // or "yes" if trust_proxy is true
   ```

3. Format the Security section:
   - "Binding:" shows bind_address with badge:
     - `[LOCAL ONLY]` in green for localhost (127.0.0.1, ::1)
     - `[NETWORK EXPOSED]` in yellow for 0.0.0.0, ::
   - "Auth users:" shows comma-separated list from config.users
     - If empty: show "None configured" in yellow
   - "Trust proxy:" shows "yes" or "no"
   - "Rate limit:" shows "{attempts} attempts / {window}s window"

4. If network exposed without users, show warning at the end:
   ```

   Warning: Network exposed without authentication!
   Add users: occ user add
   ```

5. Only show Security section when container exists (whether running or stopped).
   The security config is relevant even when stopped.
  </action>
  <verify>`occ status` (with container) shows Security section</verify>
  <done>Status command displays Security section with binding, auth users, trust proxy, rate limit</done>
</task>

<task type="auto">
  <name>Task 2: Update wizard to create container users</name>
  <files>packages/cli-rust/src/wizard/auth.rs, packages/cli-rust/src/wizard/mod.rs</files>
  <action>
Update wizard/auth.rs to create actual container users instead of just setting config:

**In auth.rs:**

1. Add imports for Docker user operations:
   ```rust
   use opencode_cloud_core::docker::{
       DockerClient, CONTAINER_NAME, create_user, set_user_password, user_exists
   };
   ```

2. Update `prompt_auth_credentials` return type to include whether container user should be created:
   - Return struct: `AuthConfig { username: String, password: String, create_in_container: bool }`
   - create_in_container is true when running full wizard with container

3. Add new function `create_container_user`:
   ```rust
   pub async fn create_container_user(
       client: &DockerClient,
       username: &str,
       password: &str,
   ) -> Result<()> {
       // Check if user already exists
       if user_exists(client, CONTAINER_NAME, username).await? {
           // User exists, just update password
           println!("  User '{}' exists, updating password...", username);
       } else {
           // Create new user
           println!("  Creating user '{}' in container...", username);
           create_user(client, CONTAINER_NAME, username).await?;
       }

       // Set password
       set_user_password(client, CONTAINER_NAME, username, password).await?;
       println!("  Password set for '{}'", username);

       Ok(())
   }
   ```

**In mod.rs (run_wizard):**

1. After collecting auth credentials and before saving config:
   - If container is running: create the user in container
   - If container not running: note that user will be created on first start

   ```rust
   // Create user in container if running
   if container_running {
       println!();
       println!("{}", style("Creating user in container...").cyan());
       create_container_user(&client, &state.username, &state.password).await?;
   } else {
       println!();
       println!(
           "{}",
           style("Note: User will be created when container starts.").dim()
       );
   }
   ```

2. Update config.users array to include the new username (for persistence)

**Migration from auth_username/auth_password:**

The Phase 5 wizard stored credentials in config.auth_username and config.auth_password fields.
With PAM-based auth, these fields are deprecated. Migration strategy:

1. On wizard run, check if config.auth_username exists and is non-empty
2. If so, migrate: add auth_username to config.users array, then clear auth_username/auth_password
3. The actual password was stored in config - it will be set via set_user_password when container starts
4. Show migration message: "Migrating existing user '{auth_username}' to PAM-based authentication..."
5. After migration, set config.auth_username = "" and config.auth_password = "" (keep fields for schema compatibility)

This one-time migration happens during wizard execution. The old fields remain in the Config struct but are ignored going forward.
  </action>
  <verify>`occ setup` with running container creates user in container; existing auth_username migrated to config.users</verify>
  <done>Wizard creates container users via create_user/set_user_password, updates config.users, migrates old auth_username/auth_password</done>
</task>

<task type="auto">
  <name>Task 3: Add first-start security check</name>
  <files>packages/cli-rust/src/commands/start.rs</files>
  <action>
Update start command to enforce security configuration on first start.

**Decision:** Block first start if no users AND no allow_unauthenticated_network. This is the safest default.

The chicken-and-egg problem (can't add users if container isn't running) is solved by:
- `occ setup` handles everything: starts container, creates user, configures security
- OR user can set `allow_unauthenticated_network: true` to explicitly opt-in to unauthenticated access

**Implementation:**

1. At the beginning of cmd_start, after loading config:
   ```rust
   // Security check: block first start without security configured
   let is_first_start = !container_exists(&client, CONTAINER_NAME).await?;

   if is_first_start && config.users.is_empty() && !config.allow_unauthenticated_network {
       return Err(anyhow!(
           "{}\n\n{}\n\n{}",
           style("Security not configured").red().bold(),
           "No users are configured for authentication.\n\
            The service cannot start without security configured.",
           format!(
               "Quick setup:\n  {}\n\n\
                Or allow unauthenticated access (not recommended):\n  {}",
               style("occ setup").cyan(),
               style("occ config set allow_unauthenticated_network true").dim()
           )
       ));
   }
   ```

2. If container already exists (not first start), allow starting even without users.
   This handles the case where user manually configured things, removed users, or is restarting an existing setup.

3. The allow_unauthenticated_network flag bypasses this check for users who explicitly opt-in.

4. The error message is clear and actionable:
   - Primary suggestion: `occ setup` (recommended path)
   - Secondary option: explicit opt-in for unauthenticated access (documented escape hatch)
  </action>
  <verify>`occ start` on fresh install without users blocks with setup prompt; `occ start` with existing container succeeds</verify>
  <done>First start blocked without security configured (users empty AND allow_unauthenticated_network false), prompts for occ setup</done>
</task>

</tasks>

<verification>
After all tasks:
1. `just fmt` - Code is formatted
2. `just lint` - No clippy warnings
3. `just test` - All tests pass
4. `just build` - Release build succeeds
5. `occ status` shows Security section with Binding, Auth users, Trust proxy
6. Wizard creates user in container when container is running
7. Wizard migrates existing auth_username to config.users
8. First start without users shows security block message
</verification>

<success_criteria>
- occ status displays Security section with all relevant info
- Security section shows bind address with badge, user list, trust proxy, rate limit
- Warning shown in status if network exposed without users
- Wizard creates container user via create_user + set_user_password
- Wizard updates config.users array
- Wizard migrates auth_username/auth_password to PAM-based config.users
- First start blocked without security configured (unless allow_unauthenticated_network is true)
- Block message suggests occ setup as primary action
</success_criteria>

<output>
After completion, create `.planning/phases/06-security-and-authentication/06-04-SUMMARY.md`
</output>
