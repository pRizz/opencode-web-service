---
phase: 10-remote-administration-via-cockpit
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/docker/Dockerfile
autonomous: true

must_haves:
  truths:
    - "Container runs systemd as PID 1"
    - "Cockpit web interface is accessible inside container on port 9090"
    - "opencode runs as a systemd service inside container"
    - "PAM users created via occ user add can authenticate to Cockpit"
  artifacts:
    - path: "packages/core/src/docker/Dockerfile"
      provides: "systemd init, Cockpit packages, opencode.service unit"
      contains: "cockpit-ws"
  key_links:
    - from: "Dockerfile CMD"
      to: "/sbin/init"
      via: "systemd as PID 1"
      pattern: 'CMD.*"/sbin/init"'
    - from: "opencode.service"
      to: "opencode binary"
      via: "systemd ExecStart"
      pattern: "ExecStart.*opencode.*web"
---

<objective>
Transform Dockerfile from tini init to systemd init with Cockpit integration

Purpose: Enable Cockpit web console by switching to systemd as PID 1, which is required for Cockpit's socket activation and service management. opencode becomes a systemd service alongside Cockpit.

Output: Updated Dockerfile that boots into systemd with Cockpit and opencode.service enabled
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-remote-administration-via-cockpit/10-CONTEXT.md
@.planning/phases/10-remote-administration-via-cockpit/10-RESEARCH.md
@packages/core/src/docker/Dockerfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add systemd and dbus packages</name>
  <files>packages/core/src/docker/Dockerfile</files>
  <action>
Add systemd, systemd-sysv, and dbus packages to the runtime stage. These are required for Cockpit to function. Add them in Group 1 (Core utilities) alongside tini/dumb-init:

```dockerfile
# Group 1: Core utilities and build tools (2026-01-22)
RUN apt-get update && apt-get install -y --no-install-recommends \
    # Init systems
    tini=0.19.* \
    dumb-init=1.2.* \
    # systemd for Cockpit support
    systemd=255.* \
    systemd-sysv=255.* \
    dbus=1.14.* \
    ...
```

After the group install, mask unnecessary systemd services to reduce startup time and avoid warnings:

```dockerfile
# Mask unnecessary systemd services for container environment
RUN systemctl mask \
    dev-hugepages.mount \
    sys-fs-fuse-connections.mount \
    systemd-update-utmp.service \
    systemd-tmpfiles-setup.service \
    systemd-remount-fs.service
```

Note: Keep tini in the image for backward compatibility (some users may want it), but systemd will become the default.
  </action>
  <verify>Verify Dockerfile contains systemd=255.* and systemctl mask commands</verify>
  <done>Dockerfile has systemd packages and masked services</done>
</task>

<task type="auto">
  <name>Task 2: Add Cockpit packages from standard Ubuntu repos</name>
  <files>packages/core/src/docker/Dockerfile</files>
  <action>
Add a new section after GitHub CLI for Cockpit installation. Install from standard Ubuntu noble repos (Cockpit ~316 available in main):

Note: Ubuntu noble (24.04) includes Cockpit 316 in main repos. While backports may have newer versions, using main repos is more reliable for container builds. The 316 version provides all needed functionality.

```dockerfile
# -----------------------------------------------------------------------------
# Cockpit Web Console (2026-01-22)
# -----------------------------------------------------------------------------
# Cockpit provides web-based administration for the container
# Ubuntu noble has cockpit 316 in main repos
USER root
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    cockpit-ws \
    cockpit-system \
    cockpit-bridge \
    && rm -rf /var/lib/apt/lists/*

# Enable Cockpit socket activation
RUN systemctl enable cockpit.socket

# Configure Cockpit for HTTP (TLS terminated externally) and proxy headers
RUN mkdir -p /etc/cockpit && \
    cat > /etc/cockpit/cockpit.conf << 'COCKPIT_CONF'
[WebService]
# Allow HTTP connections (TLS terminated externally like opencode)
AllowUnencrypted = true

# Trust proxy headers for X-Forwarded-For, X-Forwarded-Proto
ProtocolHeader = X-Forwarded-Proto
ForwardedForHeader = X-Forwarded-For

# Limit concurrent login attempts
MaxStartups = 10
COCKPIT_CONF

USER opencode
```

This installs the minimal Cockpit set (cockpit-ws, cockpit-system, cockpit-bridge) which includes:
- System overview
- Terminal access (built into cockpit-system)
- Service management
- Logs viewer

The PAM authentication is automatically configured - users created via `occ user add` (which creates Linux system users) can authenticate to Cockpit with their password.
  </action>
  <verify>Verify Dockerfile contains cockpit-ws installation and cockpit.conf</verify>
  <done>Cockpit packages installed with HTTP allowed and proxy headers configured</done>
</task>

<task type="auto">
  <name>Task 3: Create opencode systemd service and switch to systemd init</name>
  <files>packages/core/src/docker/Dockerfile</files>
  <action>
Create an opencode.service unit file in the Dockerfile and update the entrypoint to use systemd:

1. After Cockpit installation, add the opencode service unit:

```dockerfile
# Create opencode systemd service
RUN cat > /etc/systemd/system/opencode.service << 'OPENCODE_SERVICE'
[Unit]
Description=opencode Web Interface
After=network.target

[Service]
Type=simple
User=opencode
WorkingDirectory=/home/opencode/workspace
ExecStart=/home/opencode/.opencode/bin/opencode web --port 3000 --hostname 0.0.0.0
Restart=always
RestartSec=5
Environment=PATH=/home/opencode/.opencode/bin:/home/opencode/.local/bin:/home/opencode/.cargo/bin:/home/opencode/.local/share/mise/shims:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

[Install]
WantedBy=multi-user.target
OPENCODE_SERVICE

# Enable opencode service
RUN systemctl enable opencode.service
```

2. Update Final Configuration section to expose Cockpit port:

```dockerfile
# Expose opencode web port and Cockpit port
EXPOSE 3000 9090
```

3. Add required volumes for systemd:

```dockerfile
# Required volumes for systemd
VOLUME ["/sys/fs/cgroup", "/run", "/tmp"]
```

4. Update the entrypoint and cmd to use systemd:

```dockerfile
# Use SIGRTMIN+3 for proper systemd shutdown
STOPSIGNAL SIGRTMIN+3

# systemd as init (required for Cockpit)
CMD ["/sbin/init"]
```

5. Remove the old ENTRYPOINT and CMD lines that used tini and ran opencode directly.

6. Update the HEALTHCHECK to check opencode service status:

```dockerfile
# Health check for opencode service
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD systemctl is-active --quiet opencode.service && curl -f http://localhost:3000/health || exit 1
```

Note: Increased start-period from 5s to 30s because systemd takes longer to fully initialize than tini.
  </action>
  <verify>Verify Dockerfile has opencode.service, EXPOSE 9090, VOLUME declarations, and CMD ["/sbin/init"]</verify>
  <done>Dockerfile uses systemd as init with opencode as a managed service</done>
</task>

</tasks>

<verification>
1. Dockerfile contains systemd and dbus packages
2. Dockerfile installs cockpit-ws, cockpit-system, cockpit-bridge from standard repos
3. cockpit.conf exists with AllowUnencrypted = true
4. opencode.service unit file is created and enabled
5. cockpit.socket is enabled
6. CMD uses /sbin/init (systemd as PID 1)
7. EXPOSE includes both 3000 and 9090
8. VOLUME includes /sys/fs/cgroup, /run, /tmp
9. STOPSIGNAL is SIGRTMIN+3
10. HEALTHCHECK checks systemctl is-active
</verification>

<success_criteria>
- Dockerfile compiles successfully with `docker build`
- Image contains systemd as PID 1
- opencode.service and cockpit.socket are enabled
- Cockpit configuration allows HTTP connections
- Users created via `occ user add` can authenticate to Cockpit via PAM
</success_criteria>

<output>
After completion, create `.planning/phases/10-remote-administration-via-cockpit/10-01-SUMMARY.md`
</output>
