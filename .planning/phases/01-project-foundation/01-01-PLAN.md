---
phase: 01-project-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - pnpm-workspace.yaml
  - package.json
  - justfile
  - .gitignore
  - packages/core/Cargo.toml
  - packages/core/src/lib.rs
  - packages/core/src/version.rs
  - packages/core/build.rs
  - packages/core/package.json
  - packages/cli-rust/Cargo.toml
  - packages/cli-rust/src/main.rs
  - packages/cli-node/package.json
  - packages/cli-node/src/index.ts
  - packages/cli-node/tsconfig.json
  - .github/ISSUE_TEMPLATE/bug_report.md
  - .github/ISSUE_TEMPLATE/feature_request.md
  - .github/PULL_REQUEST_TEMPLATE.md
  - CONTRIBUTING.md
autonomous: true

must_haves:
  truths:
    - "User can run `cargo build --workspace` and both Rust packages compile"
    - "User can run `cargo run -p opencode-cloud --version` and see version output"
    - "User can run `pnpm install` and all Node dependencies install"
    - "User can run `just build` and both Rust and Node packages build"
  artifacts:
    - path: "Cargo.toml"
      provides: "Rust workspace root"
      contains: "[workspace]"
    - path: "packages/core/Cargo.toml"
      provides: "Core library package"
      contains: "opencode-cloud-core"
    - path: "packages/cli-rust/Cargo.toml"
      provides: "Rust CLI package"
      contains: "opencode-cloud"
    - path: "packages/core/src/lib.rs"
      provides: "Core library exports"
      min_lines: 10
    - path: "packages/cli-rust/src/main.rs"
      provides: "CLI entry point with clap"
      contains: "#[derive(Parser)]"
    - path: "justfile"
      provides: "Task orchestration"
      contains: "build:"
    - path: "pnpm-workspace.yaml"
      provides: "Node workspace config"
      contains: "packages/*"
  key_links:
    - from: "packages/cli-rust/src/main.rs"
      to: "packages/core/src/lib.rs"
      via: "Cargo dependency"
      pattern: "opencode_cloud_core"
    - from: "packages/cli-node/src/index.ts"
      to: "packages/core/package.json"
      via: "npm dependency"
      pattern: "@opencode-cloud/core"
---

<objective>
Set up the monorepo structure with Rust workspace, Node workspace, and working CLI skeletons that output version information.

Purpose: Creates the foundation for all subsequent development. Both CLIs must work at a basic level (version output) to validate the polyglot build setup.

Output: Compilable monorepo with `cargo run -p opencode-cloud --version` and `pnpm -C packages/cli-node start --version` both working.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-project-foundation/01-CONTEXT.md
@.planning/phases/01-project-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create monorepo structure and workspace configuration</name>
  <files>
    Cargo.toml
    pnpm-workspace.yaml
    package.json
    .gitignore
    justfile
    .github/ISSUE_TEMPLATE/bug_report.md
    .github/ISSUE_TEMPLATE/feature_request.md
    .github/PULL_REQUEST_TEMPLATE.md
    CONTRIBUTING.md
  </files>
  <action>
Create the monorepo root structure:

1. **Root Cargo.toml** - Rust workspace:
   - `resolver = "2"`
   - `members = ["packages/core", "packages/cli-rust"]`
   - Workspace-level package metadata (version = "0.1.0", edition = "2024", rust-version = "1.85", license = "MIT")
   - Workspace dependencies: clap (4.5, derive), tokio (1.43, rt-multi-thread + macros), serde (1.0, derive), serde_json (1.0), jsonc-parser (0.29, serde), directories (5), thiserror (2), anyhow (2), tracing (0.1), tracing-subscriber (0.3, env-filter), console (0.16), napi (2, tokio_rt + napi9), napi-derive (2)
   - Note: pidlock not in workspace deps yet (will add in Plan 02)

2. **pnpm-workspace.yaml**:
   ```yaml
   packages:
     - 'packages/*'
   ```

3. **Root package.json**:
   - name: "opencode-cloud-monorepo" (private: true)
   - packageManager: "pnpm@9.x"
   - Scripts: build, test, lint, fmt (all call `just`)
   - devDependencies: typescript, @types/node

4. **justfile** - Task orchestration (see RESEARCH.md for pattern):
   - `default: list`
   - `build: build-rust build-node`
   - `build-rust: cargo build --workspace`
   - `build-node: pnpm -r build`
   - `test: test-rust test-node`
   - `test-rust: cargo test --workspace`
   - `test-node: pnpm -r test`
   - `lint: lint-rust lint-node`
   - `lint-rust: cargo fmt --all -- --check && cargo clippy --all-targets --all-features -- -D warnings`
   - `lint-node: pnpm -r lint`
   - `fmt: cargo fmt --all && pnpm -r format`
   - `clean: cargo clean && pnpm -r clean`

5. **.gitignore** - Combined Rust + Node:
   - Standard Rust: target/, Cargo.lock (for libraries, but we include it for workspace)
   - Standard Node: node_modules/, dist/, *.tsbuildinfo
   - IDE: .idea/, .vscode/ (except .vscode/settings.json)
   - OS: .DS_Store, Thumbs.db
   - Actually include Cargo.lock (it's a binary/application project)

6. **GitHub templates**:
   - `.github/ISSUE_TEMPLATE/bug_report.md` - Bug report template
   - `.github/ISSUE_TEMPLATE/feature_request.md` - Feature request template
   - `.github/PULL_REQUEST_TEMPLATE.md` - PR template

7. **CONTRIBUTING.md** - Contributor guidelines:
   - How to set up development environment
   - How to run tests
   - Commit message format (Conventional Commits)
   - PR process
  </action>
  <verify>
    - `ls -la` shows Cargo.toml, pnpm-workspace.yaml, package.json, justfile, .gitignore
    - `ls -la .github/ISSUE_TEMPLATE/` shows templates
    - `cat CONTRIBUTING.md` shows contributor guide
  </verify>
  <done>
    Monorepo root structure exists with workspace configs, justfile, gitignore, GitHub templates, and contributor guide
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Rust core library package</name>
  <files>
    packages/core/Cargo.toml
    packages/core/src/lib.rs
    packages/core/src/version.rs
    packages/core/build.rs
    packages/core/package.json
  </files>
  <action>
Create the Rust core library that will be shared between Rust CLI and Node bindings:

1. **packages/core/Cargo.toml**:
   ```toml
   [package]
   name = "opencode-cloud-core"
   version.workspace = true
   edition.workspace = true
   rust-version.workspace = true
   license.workspace = true
   description = "Core library for opencode-cloud"

   [lib]
   crate-type = ["cdylib", "rlib"]

   [dependencies]
   clap.workspace = true
   tokio.workspace = true
   serde.workspace = true
   serde_json.workspace = true
   jsonc-parser.workspace = true
   directories.workspace = true
   thiserror.workspace = true
   anyhow.workspace = true
   tracing.workspace = true
   console.workspace = true
   napi.workspace = true
   napi-derive.workspace = true

   [build-dependencies]
   napi-build = "2"
   ```

2. **packages/core/build.rs**:
   ```rust
   extern crate napi_build;

   fn main() {
       napi_build::setup();
   }
   ```

3. **packages/core/src/lib.rs**:
   - Declare modules: `pub mod version;`
   - Re-export: `pub use version::get_version;`
   - NAPI binding: `#[napi] pub fn get_version_js() -> String { get_version() }`

4. **packages/core/src/version.rs**:
   - `pub fn get_version() -> String` - Returns CARGO_PKG_VERSION
   - `pub fn get_version_long() -> String` - Returns version + build info + git commit (use env vars set by build.rs or fallback gracefully)

5. **packages/core/package.json** (for NAPI-RS):
   ```json
   {
     "name": "@opencode-cloud/core",
     "version": "0.1.0",
     "main": "index.js",
     "types": "index.d.ts",
     "napi": {
       "name": "core",
       "triples": {}
     },
     "scripts": {
       "build": "napi build --platform --release",
       "build:debug": "napi build --platform"
     },
     "devDependencies": {
       "@napi-rs/cli": "^3.0.0-alpha.0"
     }
   }
   ```

Note: The NAPI triples are empty for now - we'll build for local platform only during development. Production CI will add the target triples.
  </action>
  <verify>
    - `cargo build -p opencode-cloud-core` compiles without errors
    - `ls packages/core/src/` shows lib.rs and version.rs
  </verify>
  <done>
    Rust core library compiles and exports version functions for both Rust and NAPI consumers
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Rust CLI package and Node CLI package</name>
  <files>
    packages/cli-rust/Cargo.toml
    packages/cli-rust/src/main.rs
    packages/cli-node/package.json
    packages/cli-node/src/index.ts
    packages/cli-node/tsconfig.json
  </files>
  <action>
Create both CLI entry points:

**Rust CLI (packages/cli-rust/):**

1. **packages/cli-rust/Cargo.toml**:
   ```toml
   [package]
   name = "opencode-cloud"
   version.workspace = true
   edition.workspace = true
   rust-version.workspace = true
   license.workspace = true
   description = "CLI for opencode-cloud"

   [[bin]]
   name = "opencode-cloud"
   path = "src/main.rs"

   [[bin]]
   name = "occ"
   path = "src/main.rs"

   [dependencies]
   opencode-cloud-core = { path = "../core" }
   clap.workspace = true
   tracing.workspace = true
   tracing-subscriber.workspace = true
   console.workspace = true
   anyhow.workspace = true
   ```

2. **packages/cli-rust/src/main.rs**:
   - Use clap derive for CLI structure
   - Global flags: --verbose/-v, --quiet/-q, --no-color
   - Subcommands enum (placeholder for now, but include Version subcommand)
   - `--version` flag handled by clap's built-in version
   - Main prints ASCII art banner on help (just the name styled)
   - Structured like:
     ```rust
     use clap::{Parser, Subcommand};
     use opencode_cloud_core::get_version;

     #[derive(Parser)]
     #[command(name = "opencode-cloud", version = get_version())]
     #[command(about = "Manage your opencode cloud service")]
     struct Cli {
         #[command(subcommand)]
         command: Option<Commands>,
         #[arg(short, long, global = true)]
         verbose: bool,
         // ... other global flags
     }

     #[derive(Subcommand)]
     enum Commands {
         // Placeholder - real commands come in later phases
     }
     ```
   - If no subcommand provided, show help

**Node CLI (packages/cli-node/):**

3. **packages/cli-node/package.json**:
   ```json
   {
     "name": "opencode-cloud",
     "version": "0.1.0",
     "type": "module",
     "bin": {
       "opencode-cloud": "./dist/index.js",
       "occ": "./dist/index.js"
     },
     "scripts": {
       "build": "tsc",
       "start": "node dist/index.js"
     },
     "dependencies": {
       "@opencode-cloud/core": "workspace:*"
     },
     "devDependencies": {
       "typescript": "^5.0.0",
       "@types/node": "^20.0.0"
     }
   }
   ```

4. **packages/cli-node/tsconfig.json**:
   - Target: ESNext
   - Module: NodeNext
   - ModuleResolution: NodeNext
   - outDir: ./dist
   - strict: true

5. **packages/cli-node/src/index.ts**:
   - Import from @opencode-cloud/core
   - Parse basic args (--version, --help)
   - For --version: call core's getVersionJs() and print
   - This is a thin wrapper - real logic lives in Rust core
   - Add shebang: `#!/usr/bin/env node`
  </action>
  <verify>
    - `cargo build --workspace` succeeds
    - `cargo run -p opencode-cloud -- --version` outputs version (e.g., "0.1.0")
    - `cargo run -p opencode-cloud -- --help` shows help with global flags
    - `pnpm install` succeeds (will fail to build core since NAPI-RS needs Rust build first - that's OK for this task)
  </verify>
  <done>
    Rust CLI shows version/help with clap. Node CLI package structure exists. `cargo run -p opencode-cloud -- --version` works.
  </done>
</task>

</tasks>

<verification>
Overall phase checks:

1. Run `cargo build --workspace` - should compile all Rust packages
2. Run `cargo run -p opencode-cloud -- --version` - should output "0.1.0"
3. Run `cargo run -p opencode-cloud -- --help` - should show help with subcommands placeholder
4. Run `just build-rust` - should work
5. Verify file structure matches RESEARCH.md recommended layout
</verification>

<success_criteria>
- Rust workspace compiles with `cargo build --workspace`
- `cargo run -p opencode-cloud -- --version` outputs version string
- `cargo run -p opencode-cloud -- --help` shows clap-formatted help
- justfile targets work: `just build-rust`, `just lint-rust`
- All required files exist in correct locations
- GitHub templates and CONTRIBUTING.md exist
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-foundation/01-01-SUMMARY.md`
</output>
