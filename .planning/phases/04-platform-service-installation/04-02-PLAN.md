---
phase: 04-platform-service-installation
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - packages/core/src/platform/systemd.rs
  - packages/core/src/platform/mod.rs
autonomous: true

must_haves:
  truths:
    - "systemd unit file is generated with correct restart policy"
    - "Service is installed to ~/.config/systemd/user/ for user mode"
    - "systemctl --user commands are invoked for enable/start"
    - "is_installed() correctly detects existing service"
  artifacts:
    - path: "packages/core/src/platform/systemd.rs"
      provides: "SystemdManager implementing ServiceManager trait"
      exports: ["SystemdManager"]
    - path: "packages/core/src/platform/mod.rs"
      provides: "Updated get_service_manager for Linux"
      contains: "SystemdManager"
  key_links:
    - from: "packages/core/src/platform/mod.rs"
      to: "packages/core/src/platform/systemd.rs"
      via: "mod systemd"
      pattern: "mod systemd"
    - from: "packages/core/src/platform/systemd.rs"
      to: "systemctl"
      via: "std::process::Command"
      pattern: "Command::new.*systemctl"
---

<objective>
Implement the SystemdManager for Linux service registration using systemd user services.

Purpose: Enables Linux users to register opencode-cloud as a systemd user service that starts on login and auto-restarts on crash.

Output: SystemdManager that generates unit files and manages service lifecycle via systemctl.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-platform-service-installation/04-CONTEXT.md
@.planning/phases/04-platform-service-installation/04-RESEARCH.md
@packages/core/src/platform/mod.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement SystemdManager Unit File Generation</name>
  <files>packages/core/src/platform/systemd.rs</files>
  <action>
Create `packages/core/src/platform/systemd.rs`:

1. Define SystemdManager struct:
   ```rust
   pub struct SystemdManager {
       user_mode: bool,  // true = ~/.config/systemd/user/, false = /etc/systemd/system/
   }
   ```

2. Implement constructor:
   ```rust
   impl SystemdManager {
       pub fn new(boot_mode: &str) -> Self {
           Self {
               user_mode: boot_mode != "system",
           }
       }
   }
   ```

3. Implement helper methods:
   - `fn service_dir(&self) -> PathBuf` - returns service directory based on user_mode
     - user: `~/.config/systemd/user/`
     - system: `/etc/systemd/system/`
   - `fn generate_unit_file(&self, config: &ServiceConfig) -> String` - generates systemd unit content

4. Unit file template (use format! macro, NOT include_str!):
   ```ini
   [Unit]
   Description=opencode-cloud container service
   Documentation=https://github.com/pRizz/opencode-cloud
   After=docker.service
   Requires=docker.service

   [Service]
   Type=simple
   ExecStart={executable_path} start --no-daemon
   ExecStop={executable_path} stop
   Restart=on-failure
   RestartSec={restart_delay}s
   StartLimitBurst={restart_retries}
   StartLimitIntervalSec={restart_delay * restart_retries * 2}

   [Install]
   WantedBy=default.target
   ```

5. Add systemd availability check:
   ```rust
   pub fn systemd_available() -> bool {
       Path::new("/run/systemd/system").exists()
   }
   ```

Note: Paths with spaces must be quoted in ExecStart. Use shell quoting if executable_path contains spaces.
  </action>
  <verify>Code compiles on Linux (use `cargo check --target x86_64-unknown-linux-gnu` if on macOS)</verify>
  <done>SystemdManager struct exists with unit file generation</done>
</task>

<task type="auto">
  <name>Task 2: Implement ServiceManager Trait for SystemdManager</name>
  <files>packages/core/src/platform/systemd.rs, packages/core/src/platform/mod.rs</files>
  <action>
1. Implement ServiceManager trait for SystemdManager:

   ```rust
   impl ServiceManager for SystemdManager {
       fn install(&self, config: &ServiceConfig) -> Result<InstallResult> {
           // 1. Create service directory if needed
           // 2. Write unit file
           // 3. Run: systemctl --user daemon-reload (or without --user for system)
           // 4. Run: systemctl --user enable opencode-cloud
           // 5. Run: systemctl --user start opencode-cloud
           // Return InstallResult with details
       }

       fn uninstall(&self) -> Result<()> {
           // 1. Run: systemctl --user stop opencode-cloud (ignore error if not running)
           // 2. Run: systemctl --user disable opencode-cloud
           // 3. Remove unit file
           // 4. Run: systemctl --user daemon-reload
       }

       fn is_installed(&self) -> Result<bool> {
           // Check if unit file exists at expected path
           Ok(self.service_file_path().exists())
       }

       fn service_file_path(&self) -> PathBuf {
           self.service_dir().join("opencode-cloud.service")
       }

       fn service_name(&self) -> &str {
           "opencode-cloud"
       }
   }
   ```

2. Add helper function for running systemctl:
   ```rust
   fn systemctl(&self, args: &[&str]) -> Result<Output> {
       let mut cmd = Command::new("systemctl");
       if self.user_mode {
           cmd.arg("--user");
       }
       cmd.args(args)
           .output()
           .map_err(|e| anyhow!("Failed to run systemctl: {}", e))
   }
   ```

3. Update `packages/core/src/platform/mod.rs`:
   - Add: `#[cfg(target_os = "linux")] mod systemd;`
   - Add: `#[cfg(target_os = "linux")] pub use systemd::SystemdManager;`
   - Update get_service_manager() for Linux:
     ```rust
     #[cfg(target_os = "linux")]
     {
         use systemd::SystemdManager;
         if !systemd::systemd_available() {
             return Err(anyhow!("systemd not available on this system"));
         }
         Ok(Box::new(SystemdManager::new("user")))
     }
     ```

4. Handle permission errors:
   - If system mode and not root, return clear error message
   - Check write permissions before attempting to write unit file
  </action>
  <verify>`just build` passes, `just test` passes (tests may skip on macOS)</verify>
  <done>SystemdManager implements ServiceManager trait, get_service_manager() returns it on Linux</done>
</task>

</tasks>

<verification>
- `just fmt && just lint && just test && just build` all pass
- SystemdManager generates valid systemd unit file content
- Service file path is ~/.config/systemd/user/opencode-cloud.service for user mode
- systemctl commands are invoked with --user flag for user mode
</verification>

<success_criteria>
- SystemdManager can generate unit file with configurable restart policy
- install() creates service file, enables, and starts service
- uninstall() stops, disables, and removes service file
- is_installed() correctly detects existing installation
- Works on Linux; compiles (but stubs) on other platforms
</success_criteria>

<output>
After completion, create `.planning/phases/04-platform-service-installation/04-02-SUMMARY.md`
</output>
