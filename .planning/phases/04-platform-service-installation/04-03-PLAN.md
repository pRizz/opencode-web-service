---
phase: 04-platform-service-installation
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - packages/core/src/platform/launchd.rs
  - packages/core/src/platform/mod.rs
  - packages/core/Cargo.toml
autonomous: true

must_haves:
  truths:
    - "launchd plist is generated with correct KeepAlive settings"
    - "Service is installed to ~/Library/LaunchAgents/ for user mode"
    - "launchctl bootstrap/bootout commands are invoked correctly"
    - "is_installed() correctly detects existing service"
  artifacts:
    - path: "packages/core/src/platform/launchd.rs"
      provides: "LaunchdManager implementing ServiceManager trait"
      exports: ["LaunchdManager"]
    - path: "packages/core/src/platform/mod.rs"
      provides: "Updated get_service_manager for macOS"
      contains: "LaunchdManager"
  key_links:
    - from: "packages/core/src/platform/mod.rs"
      to: "packages/core/src/platform/launchd.rs"
      via: "mod launchd"
      pattern: "mod launchd"
    - from: "packages/core/src/platform/launchd.rs"
      to: "plist crate"
      via: "plist::to_writer_xml"
      pattern: "plist::to_writer_xml"
---

<objective>
Implement the LaunchdManager for macOS service registration using launchd user agents.

Purpose: Enables macOS users to register opencode-cloud as a launchd user agent that starts on login and auto-restarts on crash.

Output: LaunchdManager that generates plist files and manages service lifecycle via launchctl.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-platform-service-installation/04-CONTEXT.md
@.planning/phases/04-platform-service-installation/04-RESEARCH.md
@packages/core/src/platform/mod.rs
@packages/core/Cargo.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add plist Dependency and Implement LaunchdManager Plist Generation</name>
  <files>packages/core/Cargo.toml, packages/core/src/platform/launchd.rs</files>
  <action>
1. Add plist dependency to workspace Cargo.toml (root):
   ```toml
   [workspace.dependencies]
   plist = "1.8"
   ```

2. Add plist to packages/core/Cargo.toml:
   ```toml
   plist.workspace = true
   ```

3. Create `packages/core/src/platform/launchd.rs`:

4. Define plist structures using serde:
   ```rust
   use serde::Serialize;

   #[derive(Serialize)]
   #[serde(rename_all = "PascalCase")]
   struct LaunchdPlist {
       label: String,
       program_arguments: Vec<String>,
       run_at_load: bool,
       #[serde(skip_serializing_if = "Option::is_none")]
       keep_alive: Option<KeepAliveConfig>,
       #[serde(skip_serializing_if = "Option::is_none")]
       throttle_interval: Option<u32>,
       #[serde(skip_serializing_if = "Option::is_none")]
       standard_out_path: Option<String>,
       #[serde(skip_serializing_if = "Option::is_none")]
       standard_error_path: Option<String>,
   }

   #[derive(Serialize)]
   #[serde(rename_all = "PascalCase")]
   struct KeepAliveConfig {
       #[serde(skip_serializing_if = "Option::is_none")]
       successful_exit: Option<bool>,
       #[serde(skip_serializing_if = "Option::is_none")]
       crashed: Option<bool>,
   }
   ```

5. Define LaunchdManager struct:
   ```rust
   pub struct LaunchdManager {
       user_mode: bool,  // true = ~/Library/LaunchAgents/, false = /Library/LaunchDaemons/
   }
   ```

6. Implement constructor and helpers:
   ```rust
   impl LaunchdManager {
       pub fn new(boot_mode: &str) -> Self {
           Self {
               user_mode: boot_mode != "system",
           }
       }

       fn service_dir(&self) -> PathBuf {
           if self.user_mode {
               dirs::home_dir()
                   .expect("Could not determine home directory")
                   .join("Library/LaunchAgents")
           } else {
               PathBuf::from("/Library/LaunchDaemons")
           }
       }

       fn label(&self) -> &str {
           "com.opencode-cloud.service"
       }

       fn generate_plist(&self, config: &ServiceConfig) -> LaunchdPlist {
           LaunchdPlist {
               label: self.label().to_string(),
               program_arguments: vec![
                   config.executable_path.display().to_string(),
                   "start".to_string(),
                   "--no-daemon".to_string(),
               ],
               run_at_load: true,
               keep_alive: Some(KeepAliveConfig {
                   successful_exit: Some(false),  // Only restart on non-zero exit
                   crashed: Some(true),           // Restart on crash
               }),
               throttle_interval: Some(config.restart_delay),
               standard_out_path: Some(self.log_path("stdout").display().to_string()),
               standard_error_path: Some(self.log_path("stderr").display().to_string()),
           }
       }

       fn log_path(&self, stream: &str) -> PathBuf {
           dirs::home_dir()
               .expect("Could not determine home directory")
               .join(format!("Library/Logs/opencode-cloud.{}.log", stream))
       }
   }
   ```

Note: Use `directories` crate's BaseDirs for home directory (already in deps). Actually use `dirs::home_dir()` directly since we're getting specific macOS paths.
  </action>
  <verify>Code compiles on macOS with `just build`</verify>
  <done>LaunchdManager struct exists with plist generation using plist crate</done>
</task>

<task type="auto">
  <name>Task 2: Implement ServiceManager Trait for LaunchdManager</name>
  <files>packages/core/src/platform/launchd.rs, packages/core/src/platform/mod.rs</files>
  <action>
1. Add helper function to get user ID:
   ```rust
   fn get_user_id() -> Result<u32> {
       let output = Command::new("id")
           .arg("-u")
           .output()?;
       let uid_str = String::from_utf8_lossy(&output.stdout);
       uid_str.trim().parse().map_err(|e| anyhow!("Failed to parse UID: {}", e))
   }
   ```

2. Implement ServiceManager trait for LaunchdManager:
   ```rust
   impl ServiceManager for LaunchdManager {
       fn install(&self, config: &ServiceConfig) -> Result<InstallResult> {
           // 1. Create service directory if needed (mkdir -p)
           // 2. Generate and write plist using plist::to_writer_xml
           // 3. Bootstrap using modern launchctl syntax:
           //    User mode: launchctl bootstrap gui/{uid} {plist_path}
           //    System mode: sudo launchctl bootstrap system {plist_path}
           // Return InstallResult with details
       }

       fn uninstall(&self) -> Result<()> {
           // 1. Bootout using:
           //    User mode: launchctl bootout gui/{uid}/{label}
           //    System mode: sudo launchctl bootout system/{label}
           // 2. Remove plist file
           // Note: Ignore errors if service not running (idempotent)
       }

       fn is_installed(&self) -> Result<bool> {
           Ok(self.service_file_path().exists())
       }

       fn service_file_path(&self) -> PathBuf {
           self.service_dir().join(format!("{}.plist", self.label()))
       }

       fn service_name(&self) -> &str {
           self.label()
       }
   }
   ```

3. Update `packages/core/src/platform/mod.rs`:
   - Add: `#[cfg(target_os = "macos")] mod launchd;`
   - Add: `#[cfg(target_os = "macos")] pub use launchd::LaunchdManager;`
   - Update get_service_manager() for macOS:
     ```rust
     #[cfg(target_os = "macos")]
     {
         use launchd::LaunchdManager;
         Ok(Box::new(LaunchdManager::new("user")))
     }
     ```

4. Handle errors:
   - If system mode and not root, return clear error with "Run with sudo"
   - If bootstrap fails, parse error and provide actionable message
   - Handle "service already loaded" error gracefully (bootout first, then bootstrap)
  </action>
  <verify>`just build` passes on macOS, `just test` passes</verify>
  <done>LaunchdManager implements ServiceManager trait, get_service_manager() returns it on macOS</done>
</task>

</tasks>

<verification>
- `just fmt && just lint && just test && just build` all pass
- plist crate added to dependencies
- LaunchdManager generates valid plist XML content
- Service file path is ~/Library/LaunchAgents/com.opencode-cloud.service.plist for user mode
- launchctl bootstrap/bootout commands use modern gui/{uid} syntax
</verification>

<success_criteria>
- LaunchdManager can generate plist with KeepAlive configuration
- install() creates plist, bootstraps service
- uninstall() boots out and removes plist file
- is_installed() correctly detects existing installation
- Works on macOS; compiles (but stubs) on other platforms
</success_criteria>

<output>
After completion, create `.planning/phases/04-platform-service-installation/04-03-SUMMARY.md`
</output>
