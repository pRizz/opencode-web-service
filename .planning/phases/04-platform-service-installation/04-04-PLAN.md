---
phase: 04-platform-service-installation
plan: 04
type: execute
wave: 3
depends_on: ["04-02", "04-03"]
files_modified:
  - packages/cli-rust/src/commands/install.rs
  - packages/cli-rust/src/commands/uninstall.rs
  - packages/cli-rust/src/commands/mod.rs
  - packages/cli-rust/src/commands/status.rs
  - packages/cli-rust/src/bin/opencode-cloud.rs
  - packages/cli-rust/src/bin/occ.rs
  - packages/cli-rust/Cargo.toml
autonomous: true

must_haves:
  truths:
    - "User can run occ install to register service"
    - "User can run occ uninstall to remove service registration"
    - "occ status shows installation status (Installed: yes/no)"
    - "occ install prompts if already installed (unless --force)"
    - "occ uninstall --volumes requires --force for data deletion"
  artifacts:
    - path: "packages/cli-rust/src/commands/install.rs"
      provides: "Install command implementation"
      exports: ["InstallArgs", "cmd_install"]
    - path: "packages/cli-rust/src/commands/uninstall.rs"
      provides: "Uninstall command implementation"
      exports: ["UninstallArgs", "cmd_uninstall"]
  key_links:
    - from: "packages/cli-rust/src/commands/install.rs"
      to: "opencode_cloud_core::platform"
      via: "get_service_manager"
      pattern: "get_service_manager"
    - from: "packages/cli-rust/src/bin/opencode-cloud.rs"
      to: "packages/cli-rust/src/commands/install.rs"
      via: "Commands enum"
      pattern: "Install.*cmd_install"
---

<objective>
Create install and uninstall CLI commands and integrate service installation status into the status command.

Purpose: Provides user-facing commands to register/unregister the service with the host OS service manager, completing the platform service installation feature.

Output: Working `occ install` and `occ uninstall` commands with proper feedback and confirmation prompts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-platform-service-installation/04-CONTEXT.md
@.planning/phases/04-platform-service-installation/04-RESEARCH.md
@packages/cli-rust/src/commands/mod.rs
@packages/cli-rust/src/commands/status.rs
@packages/cli-rust/src/bin/opencode-cloud.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dialoguer Dependency and Create Install Command</name>
  <files>packages/cli-rust/Cargo.toml, packages/cli-rust/src/commands/install.rs, packages/cli-rust/src/commands/mod.rs</files>
  <action>
1. Add dialoguer to workspace Cargo.toml (root) if not present:
   ```toml
   [workspace.dependencies]
   dialoguer = "0.11"
   ```

2. Add dialoguer to packages/cli-rust/Cargo.toml:
   ```toml
   dialoguer.workspace = true
   ```

3. Create `packages/cli-rust/src/commands/install.rs`:

4. Define InstallArgs:
   ```rust
   #[derive(Args)]
   pub struct InstallArgs {
       /// Skip confirmation prompt if service already installed
       #[arg(long)]
       force: bool,

       /// Show what would be done without making changes
       #[arg(long)]
       dry_run: bool,
   }
   ```

5. Implement cmd_install:
   ```rust
   pub async fn cmd_install(args: &InstallArgs, quiet: bool, _verbose: u8) -> Result<()> {
       // 1. Check platform support
       if !is_service_registration_supported() {
           return Err(anyhow!("Service registration not supported on this platform"));
       }

       // 2. Get service manager
       let manager = get_service_manager()?;

       // 3. Check if already installed
       if manager.is_installed()? {
           if args.dry_run {
               println!("Would reinstall service at: {}", manager.service_file_path().display());
               return Ok(());
           }

           if !args.force {
               // Use dialoguer for confirmation
               let confirm = Confirm::new()
                   .with_prompt("Service already installed. Reinstall?")
                   .default(false)
                   .interact()?;

               if !confirm {
                   println!("Aborted.");
                   return Ok(());
               }

               // Uninstall first
               manager.uninstall()?;
           }
       }

       // 4. Show spinner during install
       let spinner = spinner_start("Installing service...");

       // 5. Get executable path (current binary)
       let executable_path = std::env::current_exe()?;

       // 6. Load config for restart settings
       let config = load_config()?;

       // 7. Build ServiceConfig
       let service_config = ServiceConfig {
           executable_path,
           restart_retries: config.restart_retries,
           restart_delay: config.restart_delay,
           boot_mode: config.boot_mode.clone(),
       };

       // 8. Perform install
       let result = manager.install(&service_config)?;

       spinner_stop(&spinner, "Service installed");

       // 9. Print success details
       if !quiet {
           println!();
           println!("Service file: {}", style(result.service_file_path.display()).dim());
           println!("Service name: {}", result.service_name);
           if result.started {
               println!("Status:       {}", style("running").green());
           }
           println!();
           println!("The service will start automatically on {}.",
               if config.boot_mode == "system" { "boot" } else { "login" });
       }

       Ok(())
   }
   ```

6. Update packages/cli-rust/src/commands/mod.rs:
   - Add: `mod install;`
   - Add: `pub use install::{InstallArgs, cmd_install};`
  </action>
  <verify>Code compiles with `just build`</verify>
  <done>Install command exists with --force and --dry-run flags, uses dialoguer for confirmation</done>
</task>

<task type="auto">
  <name>Task 2: Create Uninstall Command</name>
  <files>packages/cli-rust/src/commands/uninstall.rs, packages/cli-rust/src/commands/mod.rs</files>
  <action>
1. Create `packages/cli-rust/src/commands/uninstall.rs`:

2. Define UninstallArgs:
   ```rust
   #[derive(Args)]
   pub struct UninstallArgs {
       /// Also remove Docker volumes (data deletion - requires --force)
       #[arg(long)]
       volumes: bool,

       /// Skip confirmation prompts
       #[arg(long)]
       force: bool,
   }
   ```

3. Implement cmd_uninstall:
   ```rust
   pub async fn cmd_uninstall(args: &UninstallArgs, quiet: bool, _verbose: u8) -> Result<()> {
       // 1. Validate --volumes requires --force
       if args.volumes && !args.force {
           return Err(anyhow!(
               "The --volumes flag requires --force to confirm data deletion.\n\
               Run: occ uninstall --volumes --force"
           ));
       }

       // 2. Check platform support
       if !is_service_registration_supported() {
           return Err(anyhow!("Service registration not supported on this platform"));
       }

       // 3. Get service manager
       let manager = get_service_manager()?;

       // 4. Check if installed
       if !manager.is_installed()? {
           if !quiet {
               println!("{}", style("Service not installed.").dim());
           }
           return Ok(());  // Exit 0 - idempotent
       }

       // 5. Stop container if running (using existing stop logic)
       let spinner = spinner_start("Stopping service...");
       // Try to stop - ignore errors if not running
       let _ = stop_container_if_running().await;
       spinner_stop(&spinner, "Service stopped");

       // 6. Uninstall service registration
       let spinner = spinner_start("Removing service registration...");
       let service_file = manager.service_file_path();
       manager.uninstall()?;
       spinner_stop(&spinner, "Service registration removed");

       // 7. Optionally remove volumes
       if args.volumes {
           let spinner = spinner_start("Removing Docker volumes...");
           remove_volumes().await?;
           spinner_stop(&spinner, "Docker volumes removed");
       }

       // 8. Print what was removed
       if !quiet {
           println!();
           println!("Removed: {}", style(service_file.display()).dim());
           if args.volumes {
               println!("Removed: Docker volumes (all data deleted)");
           }
           println!();
           println!("Service will no longer start automatically.");
       }

       Ok(())
   }

   /// Stop container if running (helper)
   async fn stop_container_if_running() -> Result<()> {
       // Similar to cmd_stop but ignores "not running" state
       let client = DockerClient::new()?;
       client.verify_connection().await?;

       // Try to stop - ignore 404/not running errors
       match client.stop_container().await {
           Ok(_) => Ok(()),
           Err(DockerError::ContainerNotRunning) => Ok(()),
           Err(e) => Err(e.into()),
       }
   }

   /// Remove Docker volumes (helper)
   async fn remove_volumes() -> Result<()> {
       let client = DockerClient::new()?;
       client.verify_connection().await?;
       // Use volume removal from docker module
       client.remove_volumes().await?;
       Ok(())
   }
   ```

Note: The remove_volumes() functionality may need to be added to DockerClient if not present. Check existing container.rs/volume.rs for volume removal.

4. Update packages/cli-rust/src/commands/mod.rs:
   - Add: `mod uninstall;`
   - Add: `pub use uninstall::{UninstallArgs, cmd_uninstall};`
  </action>
  <verify>Code compiles with `just build`</verify>
  <done>Uninstall command exists with --volumes and --force flags, idempotent behavior</done>
</task>

<task type="auto">
  <name>Task 3: Wire Commands to CLI and Update Status</name>
  <files>packages/cli-rust/src/bin/opencode-cloud.rs, packages/cli-rust/src/bin/occ.rs, packages/cli-rust/src/commands/status.rs</files>
  <action>
1. Update packages/cli-rust/src/bin/opencode-cloud.rs:
   - Add Install and Uninstall variants to Commands enum:
     ```rust
     #[derive(Subcommand)]
     enum Commands {
         // ... existing commands ...
         /// Register service to start on boot/login
         Install(InstallArgs),
         /// Remove service registration
         Uninstall(UninstallArgs),
     }
     ```
   - Add match arms:
     ```rust
     Commands::Install(args) => cmd_install(&args, cli.quiet, cli.verbose).await,
     Commands::Uninstall(args) => cmd_uninstall(&args, cli.quiet, cli.verbose).await,
     ```

2. Update packages/cli-rust/src/bin/occ.rs (same changes as opencode-cloud.rs)

3. Update packages/cli-rust/src/commands/status.rs to show installation status:
   - Import platform module
   - After printing existing status info, add:
     ```rust
     // Show installation status
     if is_service_registration_supported() {
         if let Ok(manager) = get_service_manager() {
             let installed = manager.is_installed().unwrap_or(false);
             let install_status = if installed {
                 let boot_desc = if config.boot_mode == "system" {
                     "starts on boot"
                 } else {
                     "starts on login"
                 };
                 format!("{} ({})", style("yes").green(), boot_desc)
             } else {
                 style("no").yellow().to_string()
             };
             println!("Installed:   {}", install_status);
         }
     }
     ```
   - This should appear after "Config:" line in the output

4. Ensure imports are correct in all files:
   ```rust
   use opencode_cloud_core::platform::{
       get_service_manager, is_service_registration_supported, ServiceConfig
   };
   use opencode_cloud_core::config::load_config;
   ```
  </action>
  <verify>`just build` passes, `occ --help` shows install/uninstall commands</verify>
  <done>CLI has install/uninstall commands, status shows installation status</done>
</task>

</tasks>

<verification>
- `just fmt && just lint && just test && just build` all pass
- `occ install --help` shows options
- `occ uninstall --help` shows options
- `occ status` includes "Installed: yes/no" line
- `occ uninstall --volumes` without --force returns error
</verification>

<success_criteria>
- `occ install` registers service with platform service manager
- `occ install` prompts for confirmation if already installed (unless --force)
- `occ uninstall` removes service registration
- `occ uninstall` is idempotent (exit 0 if not installed)
- `occ uninstall --volumes --force` removes Docker volumes
- `occ status` shows both running state AND installation status
- All commands have spinner feedback during operations
</success_criteria>

<output>
After completion, create `.planning/phases/04-platform-service-installation/04-04-SUMMARY.md`
</output>
