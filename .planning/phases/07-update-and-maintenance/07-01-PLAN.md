---
phase: 07-update-and-maintenance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/docker/update.rs
  - packages/core/src/docker/mod.rs
  - packages/cli-rust/src/commands/update.rs
  - packages/cli-rust/src/commands/mod.rs
  - packages/cli-rust/src/lib.rs
autonomous: true

must_haves:
  truths:
    - "User can run occ update to pull latest image"
    - "User's data volumes are preserved after update"
    - "User can rollback to previous version with occ update --rollback"
    - "Update shows step-by-step progress (stopping, pulling, creating, starting)"
  artifacts:
    - path: "packages/core/src/docker/update.rs"
      provides: "Image update and rollback operations"
      exports: ["update_image", "rollback_image", "has_previous_image"]
    - path: "packages/cli-rust/src/commands/update.rs"
      provides: "occ update command implementation"
      min_lines: 50
  key_links:
    - from: "packages/cli-rust/src/commands/update.rs"
      to: "packages/core/src/docker/update.rs"
      via: "calls update_image or rollback_image"
      pattern: "(update_image|rollback_image)\\("
    - from: "packages/core/src/docker/update.rs"
      to: "packages/core/src/docker/image.rs"
      via: "uses pull_image for fetching latest"
      pattern: "pull_image\\("
---

<objective>
Implement `occ update` command that pulls the latest Docker image, recreates the container with users preserved, and supports rollback to previous version.

Purpose: Users can update their opencode instance to the latest version with a single command, and roll back if the new version has issues.
Output: Working `occ update` and `occ update --rollback` commands with step-by-step progress feedback.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-update-and-maintenance/07-CONTEXT.md
@.planning/phases/07-update-and-maintenance/07-RESEARCH.md

# Relevant source files
@packages/core/src/docker/mod.rs
@packages/core/src/docker/image.rs
@packages/core/src/docker/container.rs
@packages/cli-rust/src/commands/start.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create docker update module with rollback support</name>
  <files>
    packages/core/src/docker/update.rs
    packages/core/src/docker/mod.rs
  </files>
  <action>
Create `packages/core/src/docker/update.rs` with update and rollback operations:

1. Add constants:
   - `PREVIOUS_TAG = "previous"` for rollback image tag

2. Implement `tag_current_as_previous(client: &DockerClient) -> Result<(), DockerError>`:
   - Use bollard's `tag_image` API (via `TagImageOptionsBuilder`)
   - Tag current `IMAGE_NAME_GHCR:IMAGE_TAG_DEFAULT` as `IMAGE_NAME_GHCR:previous`
   - Handle case where current image doesn't exist (skip tagging)

3. Implement `has_previous_image(client: &DockerClient) -> Result<bool, DockerError>`:
   - Check if `IMAGE_NAME_GHCR:previous` exists using `image_exists`

4. Implement `update_image(client: &DockerClient, progress: &mut ProgressReporter) -> Result<UpdateResult, DockerError>`:
   - Step 1: Tag current image as "previous" (for rollback)
   - Step 2: Pull latest using existing `pull_image` function
   - Return `UpdateResult::Success` or `UpdateResult::AlreadyLatest` (if pull returns same digest)
   - Use `progress.add_spinner` for each step: "Backing up current image", "Pulling latest image"

5. Implement `rollback_image(client: &DockerClient) -> Result<(), DockerError>`:
   - Check `has_previous_image` first, return error if no previous
   - Re-tag `IMAGE_NAME_GHCR:previous` as `IMAGE_NAME_GHCR:IMAGE_TAG_DEFAULT`
   - Use `TagImageOptionsBuilder` from bollard

6. Add `UpdateResult` enum: `Success`, `AlreadyLatest`

Update `packages/core/src/docker/mod.rs`:
- Add `mod update;` declaration
- Export: `pub use update::{update_image, rollback_image, has_previous_image, UpdateResult};`

Use bollard 0.18's `query_parameters::TagImageOptionsBuilder` for tag operations (not deprecated `TagImageOptions`).
  </action>
  <verify>
Run `just build` - update.rs compiles without errors.
Run `cargo doc --package opencode-cloud-core` - update module docs generate.
  </verify>
  <done>
Update module exports `update_image`, `rollback_image`, `has_previous_image`, and `UpdateResult`.
Tag operations use bollard's `TagImageOptionsBuilder` API.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create occ update CLI command</name>
  <files>
    packages/cli-rust/src/commands/update.rs
    packages/cli-rust/src/commands/mod.rs
    packages/cli-rust/src/lib.rs
  </files>
  <action>
Create `packages/cli-rust/src/commands/update.rs`:

1. Define `UpdateArgs` struct with clap:
   - `--rollback` flag: Restore previous version
   - `--yes` / `-y` flag: Skip confirmation prompt

2. Implement `cmd_update(args: UpdateArgs) -> Result<()>`:

   For normal update (no --rollback):
   - Show warning: "This will briefly stop the service to apply the update."
   - If not --yes, prompt for confirmation using dialoguer
   - Create DockerClient and verify connection
   - Show step 1: "Stopping service..." - Call `stop_service(client, true)` to stop and remove container
   - Show step 2: "Backing up current image..." - This happens inside update_image
   - Show step 3: "Pulling latest image..." - Call `update_image(client, &mut progress)`
   - Show step 4: "Recreating container..." - Call `setup_and_start` with config values
   - Show step 5: "Recreating users..." - Iterate config.users, call `create_user` and `set_user_password` for each
     - Note: Passwords are NOT stored in config. Show message: "Users recreated. You may need to reset passwords with 'occ user passwd <username>'"
   - Show success message with URL

   For rollback (--rollback):
   - Check `has_previous_image`, error if none available
   - Show warning about brief downtime
   - If not --yes, prompt for confirmation
   - Call `stop_service(client, true)`
   - Call `rollback_image(client)`
   - Call `setup_and_start` with config values
   - Recreate users (same as update)
   - Show success message

3. Use console styling:
   - Green checkmarks for completed steps
   - Yellow spinner while in progress
   - Red X for errors

Update `packages/cli-rust/src/commands/mod.rs`:
- Add `mod update;` declaration
- Export: `pub use update::{UpdateArgs, cmd_update};`

Update `packages/cli-rust/src/lib.rs`:
- Add `Update(commands::UpdateArgs)` variant to Commands enum
- Add match arm: `Commands::Update(args) => commands::cmd_update(args).await`
  </action>
  <verify>
Run `just build` - CLI compiles.
Run `occ update --help` - Shows usage with --rollback and --yes flags.
  </verify>
  <done>
`occ update` command shows step-by-step progress and updates the image.
`occ update --rollback` restores previous version.
Users are notified about password recreation requirement.
  </done>
</task>

</tasks>

<verification>
1. `just build` passes with no errors
2. `just test` passes
3. `just lint` passes
4. `occ update --help` displays help with --rollback and --yes flags
5. Manual test (optional): Run `occ update --yes` on running instance
</verification>

<success_criteria>
- `occ update` pulls latest image with progress feedback
- `occ update --rollback` restores previous version (if available)
- Update preserves data volumes (volumes are NOT removed)
- Users are recreated in new container
- Step-by-step progress shown during update
</success_criteria>

<output>
After completion, create `.planning/phases/07-update-and-maintenance/07-01-SUMMARY.md`
</output>
