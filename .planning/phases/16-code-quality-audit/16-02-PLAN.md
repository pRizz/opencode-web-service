---
phase: 16-code-quality-audit
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/cli-rust/src/output/mod.rs
  - packages/cli-rust/src/output/urls.rs
  - packages/cli-rust/src/commands/start.rs
  - packages/cli-rust/src/commands/status.rs
autonomous: true

must_haves:
  truths:
    - "Cockpit URL formatting is defined once, not duplicated 4 times in start.rs"
    - "Remote host address resolution is defined once, not duplicated 4 times"
    - "All CLI commands display consistent URLs"
    - "All tests pass without regression"
    - "Clippy passes with no warnings"
  artifacts:
    - path: "packages/cli-rust/src/output/urls.rs"
      provides: "Centralized URL formatting helpers"
      exports: ["format_cockpit_url", "resolve_remote_addr"]
  key_links:
    - from: "packages/cli-rust/src/commands/start.rs"
      to: "packages/cli-rust/src/output/urls.rs"
      via: "use crate::output::format_cockpit_url"
      pattern: "use crate::output::(format_cockpit_url|resolve_remote_addr)"
    - from: "packages/cli-rust/src/commands/status.rs"
      to: "packages/cli-rust/src/output/urls.rs"
      via: "use crate::output::resolve_remote_addr"
      pattern: "use crate::output::resolve_remote_addr"
---

<objective>
Extract duplicated URL formatting logic into shared helper functions.

Purpose: Eliminate code duplication for Cockpit URL display (4 duplications in start.rs) and remote host address resolution (4 duplications across start.rs and status.rs).
Output: Single `urls.rs` module in `packages/cli-rust/src/output/` with consistent URL formatting used by all commands.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/16-code-quality-audit/16-RESEARCH.md

# Source files with duplication
@packages/cli-rust/src/output/mod.rs
@packages/cli-rust/src/commands/start.rs
@packages/cli-rust/src/commands/status.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared urls.rs module</name>
  <files>
    packages/cli-rust/src/output/urls.rs
    packages/cli-rust/src/output/mod.rs
  </files>
  <action>
Create `packages/cli-rust/src/output/urls.rs` with centralized URL formatting:

```rust
//! URL formatting utilities
//!
//! Provides consistent URL generation for service endpoints.

use opencode_cloud_core::load_hosts;

/// Resolve the remote host address for display URLs.
///
/// Given a host name, looks up the host configuration and returns
/// the hostname for URL display purposes.
///
/// Returns None if:
/// - host_name is None
/// - Host configuration cannot be loaded
/// - Host not found in configuration
pub fn resolve_remote_addr(host_name: Option<&str>) -> Option<String> {
    host_name.and_then(|name| {
        load_hosts()
            .ok()
            .and_then(|h| h.get_host(name).map(|cfg| cfg.hostname.clone()))
    })
}

/// Format a Cockpit URL based on remote/local context.
///
/// For remote hosts, uses the remote address directly.
/// For local hosts with wildcard bind (0.0.0.0 or ::), normalizes to 127.0.0.1.
/// Otherwise uses the configured bind address.
///
/// # Arguments
/// * `maybe_remote_addr` - Optional remote host address (from resolve_remote_addr)
/// * `bind_addr` - The configured bind address (e.g., "127.0.0.1", "0.0.0.0")
/// * `cockpit_port` - The Cockpit port number
///
/// # Returns
/// Formatted URL string like "http://127.0.0.1:9090"
pub fn format_cockpit_url(
    maybe_remote_addr: Option<&str>,
    bind_addr: &str,
    cockpit_port: u16,
) -> String {
    if let Some(remote_addr) = maybe_remote_addr {
        format!("http://{}:{}", remote_addr, cockpit_port)
    } else {
        // Normalize wildcard addresses to localhost for browser access
        let cockpit_addr = if bind_addr == "0.0.0.0" || bind_addr == "::" {
            "127.0.0.1"
        } else {
            bind_addr
        };
        format!("http://{}:{}", cockpit_addr, cockpit_port)
    }
}

/// Format a service URL based on remote/local context.
///
/// Similar to format_cockpit_url but for the main opencode service.
///
/// # Arguments
/// * `maybe_remote_addr` - Optional remote host address
/// * `bind_addr` - The configured bind address
/// * `port` - The service port number
///
/// # Returns
/// Formatted URL string like "http://127.0.0.1:3000"
pub fn format_service_url(
    maybe_remote_addr: Option<&str>,
    bind_addr: &str,
    port: u16,
) -> String {
    if let Some(remote_addr) = maybe_remote_addr {
        format!("http://{}:{}", remote_addr, port)
    } else {
        format!("http://{}:{}", bind_addr, port)
    }
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn format_cockpit_url_with_remote_addr() {
        let url = format_cockpit_url(Some("192.168.1.100"), "127.0.0.1", 9090);
        assert_eq!(url, "http://192.168.1.100:9090");
    }

    #[test]
    fn format_cockpit_url_local_wildcard_ipv4() {
        let url = format_cockpit_url(None, "0.0.0.0", 9090);
        assert_eq!(url, "http://127.0.0.1:9090");
    }

    #[test]
    fn format_cockpit_url_local_wildcard_ipv6() {
        let url = format_cockpit_url(None, "::", 9090);
        assert_eq!(url, "http://127.0.0.1:9090");
    }

    #[test]
    fn format_cockpit_url_local_specific() {
        let url = format_cockpit_url(None, "10.0.0.5", 9090);
        assert_eq!(url, "http://10.0.0.5:9090");
    }

    #[test]
    fn format_service_url_with_remote() {
        let url = format_service_url(Some("prod.example.com"), "127.0.0.1", 3000);
        assert_eq!(url, "http://prod.example.com:3000");
    }

    #[test]
    fn format_service_url_local() {
        let url = format_service_url(None, "127.0.0.1", 3000);
        assert_eq!(url, "http://127.0.0.1:3000");
    }
}
```

Update `packages/cli-rust/src/output/mod.rs` to export the new module:
- Add `pub mod urls;`
- Add to `pub use`: `urls::{format_cockpit_url, format_service_url, resolve_remote_addr}`
  </action>
  <verify>`cargo check -p opencode-cloud-cli` compiles without errors</verify>
  <done>urls.rs module exists with format_cockpit_url, format_service_url, resolve_remote_addr functions; mod.rs exports them</done>
</task>

<task type="auto">
  <name>Task 2: Update start.rs to use shared URL helpers</name>
  <files>packages/cli-rust/src/commands/start.rs</files>
  <action>
Update start.rs to use the centralized URL formatting:

1. Add import (merge with existing output imports):
   `use crate::output::{format_cockpit_url, resolve_remote_addr};`

2. Remove the `load_hosts` import from the file header since it's now used internally by resolve_remote_addr (line 18).

3. Update `show_already_running()` function (~lines 395-456):
   - Replace inline `maybe_remote_addr` resolution (lines 408-412) with:
     `let maybe_remote_addr = resolve_remote_addr(host_name);`
   - Replace inline Cockpit URL formatting (lines 430-445) with:
     ```rust
     if config.cockpit_enabled {
         let cockpit_url = format_cockpit_url(
             maybe_remote_addr.as_deref(),
             bind_addr,
             config.cockpit_port,
         );
         println!("Cockpit:    {} (web admin)", cockpit_url);
     }
     ```

4. Update `show_start_result()` function (~lines 618-697):
   - Replace inline `maybe_remote_addr` resolution (lines 628-632) with:
     `let maybe_remote_addr = resolve_remote_addr(host_name);`
   - Replace inline Cockpit URL formatting (lines 662-679) with:
     ```rust
     if config.cockpit_enabled {
         let cockpit_url = format_cockpit_url(
             maybe_remote_addr.as_deref(),
             bind_addr,
             config.cockpit_port,
         );
         println!("Cockpit:    {} (web admin)", cockpit_url);
     }
     ```

Note: Keep the service URL display logic inline for now - the format_service_url helper is available but the existing code is simple enough. Only refactor Cockpit URL which has the wildcard normalization logic.
  </action>
  <verify>`cargo check -p opencode-cloud-cli` compiles; verify Cockpit URL logic only appears once (in urls.rs)</verify>
  <done>start.rs uses resolve_remote_addr and format_cockpit_url from shared module; no duplicated wildcard normalization logic</done>
</task>

<task type="auto">
  <name>Task 3: Update status.rs to use shared URL helpers</name>
  <files>packages/cli-rust/src/commands/status.rs</files>
  <action>
Update status.rs to use the centralized URL formatting:

1. Add import:
   `use crate::output::{format_cockpit_url, resolve_remote_addr};`

2. Remove the `load_hosts` import (line 16) since it's now used internally by resolve_remote_addr.

3. Update the `maybe_remote_addr` resolution (~lines 136-141):
   Replace:
   ```rust
   let maybe_remote_addr = if let Some(ref name) = host_name {
       let hosts = load_hosts().ok();
       hosts.and_then(|h| h.get_host(name).map(|cfg| cfg.hostname.clone()))
   } else {
       None
   };
   ```
   With:
   ```rust
   let maybe_remote_addr = resolve_remote_addr(host_name.as_deref());
   ```

4. Update Cockpit URL display (~lines 243-265):
   Replace the inline cockpit_addr calculation and URL formatting with:
   ```rust
   if cfg.cockpit_enabled {
       let cockpit_url = format_cockpit_url(
           maybe_remote_addr.as_deref(),
           &cfg.bind_address,
           cfg.cockpit_port,
       );
       println!(
           "Cockpit:     {} -> container:9090",
           style(&cockpit_url).cyan()
       );
       // Keep the user tip lines unchanged
   }
   ```

   Note: The status.rs Cockpit display is slightly different (shows "-> container:9090" suffix), so keep that part but use the helper for URL generation.
  </action>
  <verify>`cargo check -p opencode-cloud-cli` compiles; `just lint` passes</verify>
  <done>status.rs uses resolve_remote_addr and format_cockpit_url from shared module</done>
</task>

<task type="auto">
  <name>Task 4: Verify refactoring with full build and test</name>
  <files></files>
  <action>
Run the complete verification suite to ensure no regressions:

1. `just fmt` - Format all code
2. `just lint` - Run clippy on all targets
3. `just test` - Run all 147+ tests (should now be 153+ with new url tests)
4. `just build` - Verify release build

If any step fails, fix the issue before proceeding.

Additionally, verify the duplication is eliminated:
- `grep -r "0.0.0.0.*127.0.0.1" packages/cli-rust/src/commands/` should return 0 matches (the wildcard normalization logic moved to urls.rs)
- `grep -rn "load_hosts" packages/cli-rust/src/commands/start.rs` should return 0 matches
- `grep -rn "load_hosts" packages/cli-rust/src/commands/status.rs` should return 0 matches
  </action>
  <verify>All just commands pass; grep confirms duplication eliminated</verify>
  <done>Codebase passes all quality checks; URL formatting duplication eliminated</done>
</task>

</tasks>

<verification>
1. `just fmt && just lint && just test && just build` - All pass
2. `grep -r "0.0.0.0.*127.0.0.1" packages/cli-rust/src/commands/` - No matches (logic moved to urls.rs)
3. `grep -c "format_cockpit_url" packages/cli-rust/src/output/urls.rs` - Returns 1 (single definition)
4. URL display in start and status commands works correctly (manual spot check)
</verification>

<success_criteria>
- URL formatting helpers defined once in output/urls.rs
- start.rs and status.rs import from shared module
- No duplicated wildcard address normalization logic in commands/
- All tests pass (now 153+ with new tests)
- Clippy passes with 0 warnings
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/16-code-quality-audit/16-02-SUMMARY.md`
</output>
