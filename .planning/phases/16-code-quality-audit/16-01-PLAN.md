---
phase: 16-code-quality-audit
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/cli-rust/src/output/mod.rs
  - packages/cli-rust/src/output/errors.rs
  - packages/cli-rust/src/commands/start.rs
  - packages/cli-rust/src/commands/status.rs
  - packages/cli-rust/src/commands/stop.rs
  - packages/cli-rust/src/commands/restart.rs
  - packages/cli-rust/src/commands/logs.rs
autonomous: true

must_haves:
  truths:
    - "Docker error formatting is defined once, not duplicated across 5 files"
    - "All CLI commands display consistent Docker error messages"
    - "All tests pass without regression"
    - "Clippy passes with no warnings"
  artifacts:
    - path: "packages/cli-rust/src/output/errors.rs"
      provides: "Centralized Docker error formatting"
      exports: ["format_docker_error", "format_docker_error_anyhow", "show_docker_error"]
  key_links:
    - from: "packages/cli-rust/src/commands/start.rs"
      to: "packages/cli-rust/src/output/errors.rs"
      via: "use crate::output::format_docker_error"
      pattern: "use crate::output::(format_docker_error|show_docker_error)"
    - from: "packages/cli-rust/src/commands/status.rs"
      to: "packages/cli-rust/src/output/errors.rs"
      via: "use crate::output::format_docker_error_anyhow"
      pattern: "use crate::output::format_docker_error_anyhow"
---

<objective>
Extract duplicated `format_docker_error()` implementations into a shared helper module.

Purpose: Eliminate code duplication across 5 command files that each implement Docker error formatting with slight variations.
Output: Single `errors.rs` module in `packages/cli-rust/src/output/` with consistent error formatting used by all commands.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/16-code-quality-audit/16-RESEARCH.md

# Source files with duplication
@packages/cli-rust/src/output/mod.rs
@packages/cli-rust/src/commands/start.rs
@packages/cli-rust/src/commands/status.rs
@packages/cli-rust/src/commands/stop.rs
@packages/cli-rust/src/commands/restart.rs
@packages/cli-rust/src/commands/logs.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared errors.rs module</name>
  <files>
    packages/cli-rust/src/output/errors.rs
    packages/cli-rust/src/output/mod.rs
  </files>
  <action>
Create `packages/cli-rust/src/output/errors.rs` with centralized Docker error formatting:

```rust
//! Docker error formatting utilities
//!
//! Provides consistent, actionable error messages for Docker-related failures.

use console::style;
use opencode_cloud_core::docker::DockerError;

/// Format a Docker error into a user-friendly String with actionable guidance.
///
/// Returns styled error messages for common Docker issues:
/// - NotRunning: Instructions to start Docker
/// - PermissionDenied: Instructions to add user to docker group
/// - Connection: Connection error details with troubleshooting link
/// - Container (port): Port conflict instructions
/// - Other: Plain error message
pub fn format_docker_error(e: &DockerError) -> String {
    match e {
        DockerError::NotRunning => {
            format!(
                "{}\n\n  {}\n  {}\n\n  {}: {}",
                style("Docker is not running").red().bold(),
                "Start Docker Desktop or the Docker daemon:",
                style("  sudo systemctl start docker").cyan(),
                style("Docs").dim(),
                style("https://github.com/pRizz/opencode-cloud#troubleshooting").dim()
            )
        }
        DockerError::PermissionDenied => {
            format!(
                "{}\n\n  {}\n  {}\n  {}\n\n  {}: {}",
                style("Permission denied accessing Docker").red().bold(),
                "Add your user to the docker group:",
                style("  sudo usermod -aG docker $USER").cyan(),
                "Then log out and back in.",
                style("Docs").dim(),
                style("https://github.com/pRizz/opencode-cloud#troubleshooting").dim()
            )
        }
        DockerError::Connection(msg) => {
            format!(
                "{}\n\n  {}\n\n  {}: {}",
                style("Cannot connect to Docker").red().bold(),
                msg,
                style("Docs").dim(),
                style("https://github.com/pRizz/opencode-cloud#troubleshooting").dim()
            )
        }
        DockerError::Container(msg) if msg.contains("port") => {
            format!(
                "{}\n\n  {}\n  {}\n\n  {}: {}",
                style("Port conflict").red().bold(),
                msg,
                style("  Try: occ start --port <different-port>").cyan(),
                style("Docs").dim(),
                style("https://github.com/pRizz/opencode-cloud#troubleshooting").dim()
            )
        }
        _ => e.to_string(),
    }
}

/// Convert a Docker error to anyhow::Error with user-friendly formatting.
///
/// Use this when you need to return an anyhow::Error directly.
/// Note: This version does NOT include styled output since anyhow
/// displays the error message without ANSI codes in many contexts.
pub fn format_docker_error_anyhow(e: &DockerError) -> anyhow::Error {
    match e {
        DockerError::NotRunning => {
            anyhow::anyhow!(
                "{}\n\n  {}\n  {}",
                "Docker is not running",
                "Start Docker Desktop or the Docker daemon:",
                "  sudo systemctl start docker"
            )
        }
        DockerError::PermissionDenied => {
            anyhow::anyhow!(
                "{}\n\n  {}\n  {}\n  {}",
                "Permission denied accessing Docker",
                "Add your user to the docker group:",
                "  sudo usermod -aG docker $USER",
                "Then log out and back in."
            )
        }
        _ => anyhow::anyhow!("{e}"),
    }
}

/// Display a Docker error to stderr with rich formatting.
///
/// Prints a blank line before the error for visual separation.
pub fn show_docker_error(e: &DockerError) {
    let msg = format_docker_error(e);
    eprintln!();
    eprintln!("{msg}");
}
```

Update `packages/cli-rust/src/output/mod.rs` to export the new module:
- Add `pub mod errors;`
- Add to `pub use`: `errors::{format_docker_error, format_docker_error_anyhow, show_docker_error}`
  </action>
  <verify>`cargo check -p opencode-cloud-cli` compiles without errors</verify>
  <done>errors.rs module exists with format_docker_error, format_docker_error_anyhow, show_docker_error functions; mod.rs exports them</done>
</task>

<task type="auto">
  <name>Task 2: Update command files to use shared errors module</name>
  <files>
    packages/cli-rust/src/commands/start.rs
    packages/cli-rust/src/commands/status.rs
    packages/cli-rust/src/commands/stop.rs
    packages/cli-rust/src/commands/restart.rs
    packages/cli-rust/src/commands/logs.rs
  </files>
  <action>
Update each command file to use the centralized error formatting:

**start.rs** (lines ~722-773):
- Add import: `use crate::output::{format_docker_error, show_docker_error};` (merge with existing output imports)
- Remove the local `format_docker_error()` function definition (lines 722-766)
- Remove the local `show_docker_error()` function definition (lines 768-773)
- Keep all call sites unchanged - they already call `format_docker_error()` and `show_docker_error()`

**status.rs** (lines ~421-443):
- Add import: `use crate::output::format_docker_error_anyhow;`
- Remove the local `format_docker_error()` function definition (lines 421-443)
- Update call site at line 53 from `format_docker_error(&e)` to `format_docker_error_anyhow(&e)`

**stop.rs** (lines ~76-105):
- Add import: `use crate::output::{format_docker_error, show_docker_error};`
- Remove the local `format_docker_error()` function definition (lines 76-98)
- Remove the local `show_docker_error()` function definition (lines 100-105)
- Keep call sites unchanged

**restart.rs** (lines ~119-148):
- Add import: `use crate::output::{format_docker_error, show_docker_error};`
- Remove the local `format_docker_error()` function definition (lines 119-141)
- Remove the local `show_docker_error()` function definition (lines 143-148)
- Keep call sites unchanged

**logs.rs** (lines ~173-195):
- Add import: `use crate::output::format_docker_error_anyhow;`
- Remove the local `format_docker_error()` function definition (lines 173-195)
- Update call site at line 54 from `format_docker_error(&e)` to `format_docker_error_anyhow(&e)`

Note: The two variants (String vs anyhow::Error) exist because some call sites use `anyhow!("{msg}")` pattern while others return the error directly. Both are preserved for API compatibility.
  </action>
  <verify>`just lint` passes with no warnings; `just test` passes all tests</verify>
  <done>All 5 command files use shared error formatting from output/errors.rs; no duplicate format_docker_error definitions remain</done>
</task>

<task type="auto">
  <name>Task 3: Verify refactoring with full build and test</name>
  <files></files>
  <action>
Run the complete verification suite to ensure no regressions:

1. `just fmt` - Format all code
2. `just lint` - Run clippy on all targets
3. `just test` - Run all 147+ tests
4. `just build` - Verify release build

If any step fails, fix the issue before proceeding.

Additionally, manually verify error formatting consistency by checking that:
- `grep -r "fn format_docker_error" packages/cli-rust/src/` returns only the single definition in output/errors.rs
- `grep -r "fn show_docker_error" packages/cli-rust/src/` returns only the single definition in output/errors.rs
  </action>
  <verify>All just commands pass; grep confirms single definition of each function</verify>
  <done>Codebase passes all quality checks; duplication eliminated</done>
</task>

</tasks>

<verification>
1. `just fmt && just lint && just test && just build` - All pass
2. `grep -r "fn format_docker_error" packages/cli-rust/src/` - Single match in output/errors.rs
3. `grep -r "fn show_docker_error" packages/cli-rust/src/` - Single match in output/errors.rs
4. All CLI commands still display proper error messages (manual spot check)
</verification>

<success_criteria>
- Docker error formatting defined once in output/errors.rs
- 5 command files (start, status, stop, restart, logs) import from shared module
- No duplicate function definitions
- All tests pass (147+)
- Clippy passes with 0 warnings
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/16-code-quality-audit/16-01-SUMMARY.md`
</output>
