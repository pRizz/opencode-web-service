---
phase: 15-prebuilt-image-option
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - packages/cli-rust/src/commands/start.rs
autonomous: true

must_haves:
  truths:
    - "User can use --pull-sandbox-image to pull prebuilt image"
    - "User can use --cached-rebuild-sandbox-image to rebuild with cache"
    - "User can use --full-rebuild-sandbox-image to rebuild without cache"
    - "Using multiple image flags produces an error"
    - "When container running and image flag used, user is prompted to stop first"
    - "First start without image prompts for choice and saves to config"
    - "On pull failure after retries, user is offered to build instead"
    - "User can skip version check with --no-update-check"
  artifacts:
    - path: "packages/cli-rust/src/commands/start.rs"
      provides: "Renamed flags, pull-or-build logic, mutual exclusivity"
      contains: "pull_sandbox_image"
  key_links:
    - from: "packages/cli-rust/src/commands/start.rs"
      to: "packages/core/src/docker/image.rs"
      via: "pull_image for prebuilt, build_image for local"
      pattern: "pull_image|build_image"
    - from: "packages/cli-rust/src/commands/start.rs"
      to: "packages/core/src/docker/state.rs"
      via: "save_state after image acquisition"
      pattern: "save_state"
---

<objective>
Enhance start command with pull-or-build choice and renamed flags.

Purpose: Users can choose between fast prebuilt images (~2 min) or building from source (30-60 min) with clear flags and first-run prompts.

Output: Start command with pull support, flag renaming, mutual exclusivity, and first-run image source prompt.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-prebuilt-image-option/15-CONTEXT.md
@.planning/phases/15-prebuilt-image-option/15-RESEARCH.md
@.planning/phases/15-prebuilt-image-option/15-01-SUMMARY.md
@packages/cli-rust/src/commands/start.rs
@packages/core/src/docker/image.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename flags and add new flags to StartArgs</name>
  <files>packages/cli-rust/src/commands/start.rs</files>
  <action>
Update StartArgs struct with renamed and new flags:

```rust
/// Arguments for the start command
#[derive(Args)]
pub struct StartArgs {
    /// Port to bind on host (default: 3000)
    #[arg(short, long)]
    pub port: Option<u16>,

    /// Open browser after starting
    #[arg(long)]
    pub open: bool,

    /// Run in foreground (for service managers like systemd/launchd)
    /// Note: This is the default behavior; flag exists for compatibility
    #[arg(long)]
    pub no_daemon: bool,

    /// Pull prebuilt image from registry (fast, ~2 min)
    #[arg(long)]
    pub pull_sandbox_image: bool,

    /// Rebuild Docker image using cache (picks up Dockerfile changes)
    #[arg(long)]
    pub cached_rebuild_sandbox_image: bool,

    /// Rebuild Docker image from scratch without cache (slow, 30-60 min)
    #[arg(long)]
    pub full_rebuild_sandbox_image: bool,

    /// Skip version compatibility check between CLI and Docker image
    #[arg(long)]
    pub ignore_version: bool,

    /// Skip checking for updates on start
    #[arg(long)]
    pub no_update_check: bool,
}
```

Note: Removed the old `cached_rebuild` and `full_rebuild` fields entirely (breaking change is intentional per CONTEXT.md).
  </action>
  <verify>Run `just build` - compiles without errors</verify>
  <done>StartArgs has renamed flags and new --no-update-check flag</done>
</task>

<task type="auto">
  <name>Task 2: Implement pull-or-build logic with first-run prompt</name>
  <files>packages/cli-rust/src/commands/start.rs</files>
  <action>
Update cmd_start function with pull-or-build logic:

1. Add imports at top:
```rust
use opencode_cloud_core::docker::{
    // ... existing imports ...
    pull_image, save_state, ImageState,
};
use opencode_cloud_core::config::save_config;
```

2. After loading config, check flag mutual exclusivity:
```rust
// Check mutual exclusivity of image flags
let image_flags = [
    args.pull_sandbox_image,
    args.cached_rebuild_sandbox_image,
    args.full_rebuild_sandbox_image,
];
let flag_count = image_flags.iter().filter(|&&f| f).count();
if flag_count > 1 {
    return Err(anyhow!(
        "Only one of --pull-sandbox-image, --cached-rebuild-sandbox-image, or --full-rebuild-sandbox-image can be specified"
    ));
}
```

3. If any image flag is used while container is running, prompt to stop:
```rust
let has_image_flag = args.pull_sandbox_image || args.cached_rebuild_sandbox_image || args.full_rebuild_sandbox_image;

if has_image_flag && container_is_running(&client, CONTAINER_NAME).await? {
    if quiet {
        return Err(anyhow!("Container is running. Stop it first with: occ stop"));
    }
    let confirm = dialoguer::Confirm::new()
        .with_prompt("Container is running. Stop and apply image change?")
        .default(false)
        .interact()?;
    if !confirm {
        return Err(anyhow!("Aborted. Stop container first with: occ stop"));
    }
    // Stop the container
    stop_service(&client, true).await.ok();
}
```

4. Update the any_rebuild variable and add use_prebuilt logic:
```rust
let any_rebuild = args.cached_rebuild_sandbox_image || args.full_rebuild_sandbox_image;

// Determine image source: flag > config default
let use_prebuilt = if args.pull_sandbox_image {
    true
} else if any_rebuild {
    false
} else {
    config.image_source == "prebuilt"
};
```

5. Replace the version compatibility check section - respect --no-update-check and update_check config:
```rust
// Version compatibility check (skip if rebuilding, --ignore-version, or --no-update-check)
let should_check_version = !args.ignore_version
    && !any_rebuild
    && !args.no_update_check
    && config.update_check != "never"
    && !quiet;

if should_check_version && image_exists(&client, IMAGE_NAME_GHCR, IMAGE_TAG_DEFAULT).await? {
    // ... existing version check logic ...
}
```

6. Replace the "Build image if needed" section with pull-or-build logic:
```rust
// Acquire image if needed (first run, rebuild, or forced pull)
let needs_image = any_rebuild
    || args.pull_sandbox_image
    || !image_exists(&client, IMAGE_NAME_GHCR, IMAGE_TAG_DEFAULT).await?;

if needs_image {
    if any_rebuild {
        // Build from source
        build_docker_image(&client, args.full_rebuild_sandbox_image, verbose).await?;
        save_state(&ImageState::built(get_cli_version())).ok();
    } else if use_prebuilt {
        // Pull prebuilt image
        match pull_docker_image(&client, verbose).await {
            Ok(registry) => {
                save_state(&ImageState::prebuilt(get_cli_version(), &registry)).ok();
            }
            Err(e) => {
                // Pull failed - offer to build instead
                if !quiet {
                    eprintln!();
                    eprintln!("{} Failed to pull prebuilt image: {e}", style("Error:").red().bold());
                    eprintln!();
                    let build_instead = dialoguer::Confirm::new()
                        .with_prompt("Build from source instead? (This takes 30-60 minutes)")
                        .default(true)
                        .interact()?;
                    if build_instead {
                        build_docker_image(&client, false, verbose).await?;
                        save_state(&ImageState::built(get_cli_version())).ok();
                    } else {
                        return Err(anyhow!("Cannot proceed without image. Run 'occ start --full-rebuild-sandbox-image' to build from source."));
                    }
                } else {
                    return Err(e.into());
                }
            }
        }
    } else {
        // Build from source (config.image_source == "build")
        build_docker_image(&client, false, verbose).await?;
        save_state(&ImageState::built(get_cli_version())).ok();
    }
}
```

7. Add helper function for pulling with nice output:
```rust
/// Pull the Docker image with progress reporting
/// Returns the registry name on success (for provenance tracking)
async fn pull_docker_image(client: &DockerClient, verbose: u8) -> Result<String> {
    if verbose > 0 {
        eprintln!(
            "{} Pulling prebuilt Docker image from registry...",
            style("[info]").cyan()
        );
    }

    let mut progress = ProgressReporter::with_context("Pulling prebuilt image");
    let full_image = pull_image(client, Some(IMAGE_TAG_DEFAULT), &mut progress).await?;

    // Extract registry from full image name
    let registry = if full_image.starts_with("ghcr.io") {
        "ghcr.io"
    } else if full_image.starts_with("docker.io") || full_image.starts_with("prizz/") {
        "docker.io"
    } else {
        "unknown"
    };

    Ok(registry.to_string())
}
```

8. Add first-run prompt if image doesn't exist and no flag specified:
Before the "needs_image" check, if it's first run (no image exists) and no flags were specified, prompt for choice and save to config:

```rust
// First-run image source prompt (if no image and no flag specified)
let image_already_exists = image_exists(&client, IMAGE_NAME_GHCR, IMAGE_TAG_DEFAULT).await?;
if !image_already_exists && !has_image_flag && !quiet {
    let (new_use_prebuilt, updated_config) = prompt_image_source_choice(&config)?;
    // Save config with new image_source
    if updated_config.image_source != config.image_source {
        save_config(&updated_config)?;
    }
    // Use the choice for this run
    use_prebuilt = new_use_prebuilt;
}
```

Add the prompt function:
```rust
/// Prompt user to choose between prebuilt and build from source
fn prompt_image_source_choice(config: &opencode_cloud_core::Config) -> Result<(bool, opencode_cloud_core::Config)> {
    println!();
    println!("{}", style("Docker Image Setup").cyan().bold());
    println!("{}", style("=".repeat(20)).dim());
    println!();
    println!("Choose how to get the opencode-cloud Docker image:");
    println!();
    println!("  {} Pull prebuilt image (~2 min)", style("[1]").bold());
    println!("      Fast download from GitHub Container Registry");
    println!("      Published automatically, verified builds");
    println!();
    println!("  {} Build from source (30-60 min)", style("[2]").bold());
    println!("      Compile locally for customization/auditing");
    println!("      Full transparency, modify Dockerfile if needed");
    println!();
    println!("{}", style("Transparency: https://github.com/pRizz/opencode-cloud/actions/workflows/version-bump.yml").dim());
    println!();

    let options = vec![
        "Pull prebuilt image (recommended, ~2 min)",
        "Build from source (30-60 min)",
    ];

    let selection = dialoguer::Select::new()
        .with_prompt("Select image source")
        .items(&options)
        .default(0)
        .interact()
        .map_err(|_| anyhow!("Setup cancelled"))?;

    let use_prebuilt = selection == 0;
    let mut new_config = config.clone();
    new_config.image_source = if use_prebuilt { "prebuilt" } else { "build" }.to_string();

    println!();
    if use_prebuilt {
        println!("{}", style("Using prebuilt image. You can change this later with:").dim());
        println!("  {}", style("occ config set image_source build").cyan());
    } else {
        println!("{}", style("Building from source. You can change this later with:").dim());
        println!("  {}", style("occ config set image_source prebuilt").cyan());
    }
    println!();

    Ok((use_prebuilt, new_config))
}
```
  </action>
  <verify>
1. `just fmt && just lint` - Code is clean
2. `just test` - All tests pass
3. `just build` - Release builds
4. Manual test: `occ start --help` shows new flag names
5. Manual test: `occ start --pull-sandbox-image --full-rebuild-sandbox-image` returns mutual exclusivity error
  </verify>
  <done>Start command has pull-or-build logic with first-run prompt and flag changes</done>
</task>

</tasks>

<verification>
1. `just fmt` - Code is formatted
2. `just lint` - No clippy warnings
3. `just test` - All tests pass
4. `just build` - Release build succeeds
5. `occ start --help` shows: --pull-sandbox-image, --cached-rebuild-sandbox-image, --full-rebuild-sandbox-image, --no-update-check
6. Verify mutual exclusivity: `occ start --pull-sandbox-image --full-rebuild-sandbox-image` errors
</verification>

<success_criteria>
- Old flags (--cached-rebuild, --full-rebuild) are removed
- New flags (--pull-sandbox-image, --cached-rebuild-sandbox-image, --full-rebuild-sandbox-image, --no-update-check) work
- Combining image flags produces clear error message
- First run without image prompts for source choice
- Choice is saved to config.image_source
- Pull failure offers fallback to build
- Image provenance is saved after acquisition
</success_criteria>

<output>
After completion, create `.planning/phases/15-prebuilt-image-option/15-02-SUMMARY.md`
</output>
