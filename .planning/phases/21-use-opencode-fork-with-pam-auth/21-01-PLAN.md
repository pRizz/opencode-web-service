---
phase: 21-use-opencode-fork-with-pam-auth
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/docker/Dockerfile
autonomous: true

must_haves:
  truths:
    - "Dockerfile installs opencode from pRizz/opencode fork (commit 11277fd04fb7f6df4b6f188397dcb5275ef3a78f)"
    - "Dockerfile builds and installs opencode-broker binary"
    - "PAM configuration file installed at /etc/pam.d/opencode"
    - "opencode-broker.service systemd unit created and enabled"
    - "opencode.service updated with After=opencode-broker.service dependency"
    - "opencode.json config file created with auth enabled"
  artifacts:
    - path: "packages/core/src/docker/Dockerfile"
      provides: "Updated Dockerfile with fork installation, broker, PAM config, and services"
      min_lines: 50
  key_links:
    - from: "packages/core/src/docker/Dockerfile"
      to: "opencode fork"
      via: "git clone and bun build"
      pattern: "github.com/pRizz/opencode"
---

<objective>
Update Dockerfile to install opencode from pRizz/opencode fork, build opencode-broker, install PAM configuration, and set up systemd services for PAM-based authentication.

Purpose: Switch from mainline opencode (basic auth) to the fork with PAM authentication, enabling users created via `occ user add` to authenticate to the opencode web UI.

Output: Complete Dockerfile with fork installation, broker service, PAM config, and updated opencode service that depends on broker.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-use-opencode-fork-with-pam-auth/21-CONTEXT.md
@packages/core/src/docker/Dockerfile
@packages/core/src/docker/dockerfile.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace opencode installation with fork build</name>
  <files>packages/core/src/docker/Dockerfile</files>
  <action>
Replace the opencode installation section (lines 419-433) with fork installation:

1. **Remove the old installer script section:**
   - Remove lines 419-433 (the curl installer with retry logic)

2. **Add fork installation section:**
```dockerfile
# -----------------------------------------------------------------------------
# opencode Installation (Fork from pRizz/opencode)
# -----------------------------------------------------------------------------
# Clone the fork and build from source
# Pin to specific commit for reproducibility: 11277fd04fb7f6df4b6f188397dcb5275ef3a78f
RUN git clone --depth 1 https://github.com/pRizz/opencode.git /tmp/opencode \
    && cd /tmp/opencode \
    && git checkout 11277fd04fb7f6df4b6f188397dcb5275ef3a78f \
    && bun install --frozen-lockfile \
    && bun run packages/opencode/script/build.ts --single \
    && mkdir -p /home/opencode/.opencode/bin \
    && cp /tmp/opencode/packages/opencode/dist/opencode-*/bin/opencode /home/opencode/.opencode/bin/opencode \
    && chmod +x /home/opencode/.opencode/bin/opencode \
    && rm -rf /tmp/opencode \
    && /home/opencode/.opencode/bin/opencode --version

# Add opencode to PATH
ENV PATH="/home/opencode/.opencode/bin:${PATH}"
```

**Key points:**
- Use `--depth 1` to minimize clone size
- Checkout specific commit for reproducibility
- Use `bun install --frozen-lockfile` for deterministic builds
- Use `--single` flag to build only for current platform
- Copy binary from dist directory (wildcard matches platform-specific output)
- Verify installation with `--version` check
- Clean up /tmp/opencode after installation

**Note:** Bun should already be available from earlier in the Dockerfile (via mise or direct install).
  </action>
  <verify>
Verify Dockerfile syntax is valid and the git clone/build commands are correct.
  </verify>
  <done>
opencode installation section replaced with fork build from source, pinned to commit 11277fd04fb7f6df4b6f188397dcb5275ef3a78f.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build and install opencode-broker</name>
  <files>packages/core/src/docker/Dockerfile</files>
  <action>
Add a new section after opencode installation to build and install opencode-broker:

1. **Add broker build section (after opencode installation, before GSD plugin):**
```dockerfile
# -----------------------------------------------------------------------------
# opencode-broker Installation
# -----------------------------------------------------------------------------
# Build opencode-broker from source (Rust service for PAM authentication)
# The broker handles PAM authentication and user process spawning
RUN git clone --depth 1 https://github.com/pRizz/opencode.git /tmp/opencode-broker \
    && cd /tmp/opencode-broker \
    && git checkout 11277fd04fb7f6df4b6f188397dcb5275ef3a78f \
    && cd packages/opencode-broker \
    && cargo build --release \
    && mkdir -p /usr/local/bin \
    && cp target/release/opencode-broker /usr/local/bin/opencode-broker \
    && chmod 4755 /usr/local/bin/opencode-broker \
    && rm -rf /tmp/opencode-broker

# Verify broker binary exists and is executable
RUN ls -la /usr/local/bin/opencode-broker && /usr/local/bin/opencode-broker --version || echo "Broker installed (version check may not be available)"
```

**Key points:**
- Clone the same fork repo (can reuse same commit)
- Build from `packages/opencode-broker` directory
- Use `cargo build --release` for optimized binary
- Install to `/usr/local/bin/opencode-broker`
- Set setuid permissions (`chmod 4755`) so broker can access PAM
- Clean up build directory after installation
- Version check may fail if broker doesn't support `--version`, that's okay

**Note:** This runs as `opencode` user, but we need root for setuid. We'll switch to root before this section or run as root and switch back.
  </action>
  <verify>
Verify broker build section is placed correctly and uses correct paths.
  </verify>
  <done>
opencode-broker build and installation section added to Dockerfile.
  </done>
</task>

<task type="auto">
  <name>Task 3: Install PAM configuration file</name>
  <files>packages/core/src/docker/Dockerfile</files>
  <action>
Add PAM configuration installation section (after broker installation, before systemd services):

1. **Add PAM config section:**
```dockerfile
# -----------------------------------------------------------------------------
# PAM Configuration
# -----------------------------------------------------------------------------
# Install PAM configuration for opencode authentication
# This allows opencode to authenticate users via PAM (same users as Cockpit)
USER root
RUN printf '%s\n' \
    '# PAM configuration for OpenCode authentication' \
    '# Install to /etc/pam.d/opencode' \
    '' \
    '# Standard UNIX authentication' \
    'auth required pam_unix.so' \
    'account required pam_unix.so' \
    '' \
    '# Optional: Enable TOTP 2FA (uncomment when pam_google_authenticator is installed)' \
    '# auth required pam_google_authenticator.so' \
    > /etc/pam.d/opencode \
    && chmod 644 /etc/pam.d/opencode

# Verify PAM config file exists
RUN ls -la /etc/pam.d/opencode && cat /etc/pam.d/opencode
```

**Key points:**
- Switch to root user (PAM config must be in /etc/pam.d/)
- Create file with standard UNIX authentication
- Include commented 2FA option for future use
- Set appropriate permissions (644)
- Verify file creation

**Note:** This matches the content from `packages/opencode-broker/service/opencode.pam` in the fork.
  </action>
  <verify>
Verify PAM config file content matches the fork's opencode.pam file structure.
  </verify>
  <done>
PAM configuration file installed at /etc/pam.d/opencode with standard UNIX authentication.
  </done>
</task>

<task type="auto">
  <name>Task 4: Create opencode-broker systemd service</name>
  <files>packages/core/src/docker/Dockerfile</files>
  <action>
Add opencode-broker.service systemd unit file (after PAM config, before opencode.service):

1. **Add broker service section:**
```dockerfile
# -----------------------------------------------------------------------------
# opencode-broker systemd Service
# -----------------------------------------------------------------------------
# Create opencode-broker service for PAM authentication
RUN printf '%s\n' \
    '[Unit]' \
    'Description=OpenCode Authentication Broker' \
    'Documentation=https://github.com/pRizz/opencode' \
    'After=network.target' \
    '' \
    '[Service]' \
    'Type=notify' \
    'ExecStart=/usr/local/bin/opencode-broker' \
    'ExecReload=/bin/kill -HUP $MAINPID' \
    'Restart=always' \
    'RestartSec=5' \
    '' \
    '# Security hardening' \
    'NoNewPrivileges=false' \
    'ProtectSystem=strict' \
    'ProtectHome=read-only' \
    'PrivateTmp=true' \
    'ReadWritePaths=/run/opencode' \
    '' \
    '# Socket directory' \
    'RuntimeDirectory=opencode' \
    'RuntimeDirectoryMode=0755' \
    '' \
    '# Logging' \
    'StandardOutput=journal' \
    'StandardError=journal' \
    'SyslogIdentifier=opencode-broker' \
    '' \
    '[Install]' \
    'WantedBy=multi-user.target' \
    > /etc/systemd/system/opencode-broker.service

# Enable opencode-broker service
RUN mkdir -p /etc/systemd/system/multi-user.target.wants \
    && ln -sf /etc/systemd/system/opencode-broker.service /etc/systemd/system/multi-user.target.wants/opencode-broker.service
```

**Key points:**
- Service runs as root (needed for PAM access)
- Type=notify for readiness signaling
- RuntimeDirectory creates /run/opencode for socket
- Security hardening settings from fork's service file
- Enable service via symlink (systemctl doesn't work during build)

**Note:** This should be placed before opencode.service so opencode can depend on it.
  </action>
  <verify>
Verify service file content matches the fork's opencode-broker.service file.
  </verify>
  <done>
opencode-broker.service systemd unit created and enabled.
  </done>
</task>

<task type="auto">
  <name>Task 5: Update opencode.service with broker dependency</name>
  <files>packages/core/src/docker/Dockerfile</files>
  <action>
Update the existing opencode.service section (lines 444-468) to depend on opencode-broker:

1. **Modify the opencode.service creation:**
   - Find the section that creates `/etc/systemd/system/opencode.service`
   - Update the `[Unit]` section to add: `After=opencode-broker.service`
   - Keep all other settings the same

**Updated section should look like:**
```dockerfile
# -----------------------------------------------------------------------------
# opencode systemd Service (2026-01-22)
# -----------------------------------------------------------------------------
# Create opencode as a systemd service for Cockpit integration
USER root
RUN printf '%s\n' \
    '[Unit]' \
    'Description=opencode Web Interface' \
    'After=network.target opencode-broker.service' \
    '' \
    '[Service]' \
    'Type=simple' \
    'User=opencode' \
    'WorkingDirectory=/home/opencode/workspace' \
    'ExecStart=/home/opencode/.opencode/bin/opencode web --port 3000 --hostname 0.0.0.0' \
    'Restart=always' \
    'RestartSec=5' \
    'Environment=PATH=/home/opencode/.opencode/bin:/home/opencode/.local/bin:/home/opencode/.cargo/bin:/home/opencode/.local/share/mise/shims:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin' \
    '' \
    '[Install]' \
    'WantedBy=multi-user.target' \
    > /etc/systemd/system/opencode.service

# Enable opencode service to start at boot (manual symlink since systemctl doesn't work during build)
RUN mkdir -p /etc/systemd/system/multi-user.target.wants \
    && ln -sf /etc/systemd/system/opencode.service /etc/systemd/system/multi-user.target.wants/opencode.service
```

**Key change:**
- `After=network.target` â†’ `After=network.target opencode-broker.service`

This ensures the broker starts before opencode and creates the socket.
  </action>
  <verify>
Verify opencode.service has the broker dependency in the After line.
  </verify>
  <done>
opencode.service updated with After=opencode-broker.service dependency.
  </done>
</task>

<task type="auto">
  <name>Task 6: Create opencode.json config with auth enabled</name>
  <files>packages/core/src/docker/Dockerfile</files>
  <action>
Add opencode configuration file creation (after opencode.service, before switching back to opencode user):

1. **Add config file creation section:**
```dockerfile
# -----------------------------------------------------------------------------
# opencode Configuration
# -----------------------------------------------------------------------------
# Create opencode.json config file with PAM authentication enabled
RUN mkdir -p /home/opencode/.config/opencode \
    && printf '%s\n' \
    '{' \
    '  "auth": {' \
    '    "enabled": true' \
    '  }' \
    '}' \
    > /home/opencode/.config/opencode/opencode.json \
    && chown -R opencode:opencode /home/opencode/.config/opencode \
    && chmod 644 /home/opencode/.config/opencode/opencode.json

# Verify config file exists
RUN ls -la /home/opencode/.config/opencode/opencode.json && cat /home/opencode/.config/opencode/opencode.json
```

**Key points:**
- Create config directory if it doesn't exist
- Write minimal JSON config with auth enabled
- Set ownership to opencode user
- Set appropriate permissions (644)
- Verify file creation

**Note:** This runs as root (from previous USER root), so we can set ownership. Then switch back to opencode user after this.
  </action>
  <verify>
Verify config file is created with correct JSON syntax and permissions.
  </verify>
  <done>
opencode.json config file created with auth enabled at /home/opencode/.config/opencode/opencode.json.
  </done>
</task>

</tasks>

<verification>
1. Dockerfile compiles successfully (no syntax errors)
2. All sections are in correct order:
   - opencode fork installation
   - opencode-broker build and installation
   - PAM configuration
   - opencode-broker.service
   - opencode.service (with broker dependency)
   - opencode.json config
3. Commit hash is correct: 11277fd04fb7f6df4b6f188397dcb5275ef3a78f
4. Service dependencies are correct (opencode After=opencode-broker.service)
5. File permissions are appropriate (setuid for broker, 644 for configs)
6. All cleanup steps remove temporary directories
</verification>

<success_criteria>
- Dockerfile installs opencode from pRizz/opencode fork (pinned to commit)
- Dockerfile builds and installs opencode-broker binary with setuid permissions
- PAM configuration file exists at /etc/pam.d/opencode
- opencode-broker.service systemd unit is created and enabled
- opencode.service has After=opencode-broker.service dependency
- opencode.json config file exists with auth enabled
- Docker build completes successfully
- All temporary build directories are cleaned up
</success_criteria>
