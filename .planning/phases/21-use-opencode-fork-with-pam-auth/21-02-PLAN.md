---
phase: 21-use-opencode-fork-with-pam-auth
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - README.md
  - packages/core/README.md
  - packages/core/src/config/schema.rs
autonomous: true

must_haves:
  truths:
    - "README documents PAM-based authentication flow"
    - "README explains legacy auth_username/auth_password fields are deprecated"
    - "Config schema comments clarify legacy fields are ignored"
    - "Documentation explains users created via occ user add can log into opencode web UI"
  artifacts:
    - path: "README.md"
      provides: "Updated authentication documentation"
      min_lines: 20
  key_links:
    - from: "README.md"
      to: "PAM authentication"
      via: "Documentation section"
      pattern: "PAM|authentication|occ user add"
---

<objective>
Update documentation to reflect PAM-based authentication and clarify that legacy auth_username/auth_password fields are deprecated but kept for backward compatibility.

Purpose: Users need clear documentation about the new PAM authentication flow and understand that legacy auth fields are no longer used.

Output: Updated README and config schema documentation explaining PAM authentication, legacy field deprecation, and how to use occ user commands.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-use-opencode-fork-with-pam-auth/21-CONTEXT.md
@README.md
@packages/core/README.md
@packages/core/src/config/schema.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update README.md authentication section</name>
  <files>README.md</files>
  <action>
Find and update the authentication/security section in README.md to document PAM-based authentication:

1. **Locate authentication section** (search for "auth", "authentication", "security", or "login")

2. **Add or update section with:**
```markdown
## Authentication

opencode-cloud uses **PAM (Pluggable Authentication Modules)** for authentication. Users created via `occ user add` can authenticate to both:
- **opencode web UI** - Access the coding interface
- **Cockpit** - System administration interface

### Creating Users

Create a user with a password:
```bash
occ user add <username>
```

Generate a random password:
```bash
occ user add <username> --generate
```

### Managing Users

- List users: `occ user list`
- Change password: `occ user passwd <username>`
- Remove user: `occ user remove <username>`
- Enable/disable account: `occ user enable <username>` / `occ user disable <username>`

### Legacy Authentication Fields

The `auth_username` and `auth_password` config fields are **deprecated** and ignored. They are kept in the config schema for backward compatibility with existing deployments, but new users should be created via `occ user add` instead.

To migrate from legacy fields:
1. Create a PAM user: `occ user add <username>`
2. The legacy fields will be automatically cleared on next config save
```

3. **Update any existing authentication documentation** to reference PAM instead of basic auth

**Note:** If README doesn't have an authentication section, add it after the "Usage" or "Security" section.
  </action>
  <verify>
README.md contains clear documentation about PAM authentication and legacy field deprecation.
  </verify>
  <done>
README.md updated with PAM authentication documentation and legacy field deprecation notice.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update packages/core/README.md if it has auth docs</name>
  <files>packages/core/README.md</files>
  <action>
Check if packages/core/README.md has authentication documentation and update it similarly:

1. **Search for authentication-related content** in packages/core/README.md

2. **If found, update to:**
   - Reference PAM authentication
   - Explain `occ user add` commands
   - Note legacy field deprecation

3. **If not found, no changes needed** (core library README may not need auth docs)

**Note:** This is optional - only update if the file contains authentication documentation.
  </action>
  <verify>
If packages/core/README.md had auth docs, they're updated to reflect PAM authentication.
  </verify>
  <done>
packages/core/README.md updated if it contained authentication documentation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update config schema comments for legacy fields</name>
  <files>packages/core/src/config/schema.rs</files>
  <action>
Update the documentation comments for `auth_username` and `auth_password` fields to clearly mark them as deprecated:

1. **Find the field definitions** (around lines 45-51)

2. **Update comments to:**
```rust
/// Username for opencode basic auth (DEPRECATED - use PAM users via `occ user add` instead)
/// 
/// This field is kept for backward compatibility but is ignored.
/// New deployments should create users via `occ user add` which uses PAM authentication.
/// Legacy deployments can migrate by running `occ user add <username>`.
#[serde(default)]
pub auth_username: Option<String>,

/// Password for opencode basic auth (DEPRECATED - use PAM users via `occ user add` instead)
/// 
/// This field is kept for backward compatibility but is ignored.
/// Passwords are stored in the container's /etc/shadow via PAM, not in config files.
#[serde(default)]
pub auth_password: Option<String>,
```

3. **Update the `has_required_auth()` method comment** if it references legacy fields:
   - Ensure it clearly states legacy fields are ignored
   - Document that only `config.users` array is checked for PAM auth

**Key points:**
- Mark fields as DEPRECATED in comments
- Explain why they're kept (backward compatibility)
- Direct users to `occ user add` for new deployments
- Note that passwords are stored in /etc/shadow, not config
  </action>
  <verify>
Config schema comments clearly mark legacy fields as deprecated and explain the migration path.
  </verify>
  <done>
Config schema comments updated to mark auth_username/auth_password as deprecated with clear migration guidance.
  </done>
</task>

</tasks>

<verification>
1. README.md contains PAM authentication documentation
2. README.md explains legacy field deprecation
3. Config schema comments mark legacy fields as deprecated
4. Documentation is clear about using `occ user add` instead of legacy fields
5. All documentation is consistent across files
</verification>

<success_criteria>
- README.md documents PAM-based authentication flow
- README.md explains legacy auth_username/auth_password fields are deprecated
- Config schema comments clearly mark legacy fields as deprecated
- Documentation explains users created via `occ user add` can log into opencode web UI
- Documentation is clear and actionable for users
- No conflicting information about authentication methods
</success_criteria>
