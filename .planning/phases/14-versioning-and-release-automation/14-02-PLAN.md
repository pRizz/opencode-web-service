# Plan 14-02: Version Detection in CLI

## Objective

Add CLI capability to detect Docker image version and compare with CLI version, prompting users when versions differ.

## Overview

1. Add function to read image version label via Docker API
2. On `start` command, compare CLI version with image version
3. Display image version in `status` output
4. Add `--ignore-version` flag to bypass mismatch check

## Prerequisites

- Plan 14-01 complete (version label added to Dockerfile)

## Tasks

### 1. Add Image Version Detection Module

**File:** `packages/core/src/docker/version.rs` (new file)

```rust
//! Docker image version detection
//!
//! Reads version information from Docker image labels.

use super::{DockerClient, DockerError};

/// Version label key in Docker image
pub const VERSION_LABEL: &str = "org.opencode-cloud.version";

/// Get version from image label
///
/// Returns None if image doesn't exist or has no version label.
/// Version label is set during automated builds; local builds have "dev".
pub async fn get_image_version(
    client: &DockerClient,
    image_name: &str,
) -> Result<Option<String>, DockerError> {
    let inspect = match client.inner().inspect_image(image_name).await {
        Ok(info) => info,
        Err(bollard::errors::Error::DockerResponseServerError { status_code: 404, .. }) => {
            return Ok(None);
        }
        Err(e) => {
            return Err(DockerError::Other(format!("Failed to inspect image: {e}")));
        }
    };

    // Extract version from labels
    let version = inspect
        .config
        .and_then(|c| c.labels)
        .and_then(|labels| labels.get(VERSION_LABEL).cloned());

    Ok(version)
}

/// CLI version from Cargo.toml
pub fn get_cli_version() -> &'static str {
    env!("CARGO_PKG_VERSION")
}

/// Compare versions and determine if they match
///
/// Returns true if versions are compatible (same or dev build).
/// Returns false if versions differ and user should be prompted.
pub fn versions_compatible(cli_version: &str, image_version: Option<&str>) -> bool {
    match image_version {
        None => true, // No version label = local build, assume compatible
        Some("dev") => true, // Dev build, assume compatible
        Some(img_ver) => cli_version == img_ver,
    }
}
```

### 2. Export Module from docker/mod.rs

**File:** `packages/core/src/docker/mod.rs`

Add to module declarations:
```rust
pub mod version;
```

Add to exports:
```rust
pub use version::{get_image_version, get_cli_version, versions_compatible, VERSION_LABEL};
```

### 3. Add --ignore-version Flag to Start Command

**File:** `packages/cli-rust/src/commands/start.rs`

Add to `StartArgs`:
```rust
/// Skip version compatibility check between CLI and Docker image
#[arg(long)]
pub ignore_version: bool,
```

### 4. Add Version Check in Start Command

**File:** `packages/cli-rust/src/commands/start.rs`

After Docker connection verification and before starting, add version check:

```rust
use opencode_cloud_core::docker::{
    get_image_version, get_cli_version, versions_compatible, IMAGE_NAME_GHCR,
};

// ... in cmd_start, after verify_connection ...

// Version compatibility check (skip if rebuilding)
if !args.ignore_version && !any_rebuild {
    let cli_version = get_cli_version();
    let image_tag = format!("{}:{}", IMAGE_NAME_GHCR, IMAGE_TAG_DEFAULT);

    if let Ok(Some(image_version)) = get_image_version(&client, &image_tag).await {
        if !versions_compatible(cli_version, Some(&image_version)) {
            println!();
            println!(
                "{} Version mismatch detected",
                style("âš ").yellow()
            );
            println!(
                "  CLI version:   {}",
                style(cli_version).cyan()
            );
            println!(
                "  Image version: {}",
                style(&image_version).cyan()
            );
            println!();

            // Prompt for action
            let options = vec![
                "Pull new image (recommended)",
                "Rebuild from source",
                "Continue anyway",
            ];

            let selection = dialoguer::Select::new()
                .with_prompt("What would you like to do?")
                .items(&options)
                .default(0)
                .interact()?;

            match selection {
                0 => {
                    // Pull new image
                    // ... trigger pull logic
                }
                1 => {
                    // Set rebuild flag
                    // ... trigger rebuild logic
                }
                2 => {
                    // Continue - do nothing
                }
                _ => unreachable!(),
            }
        }
    }
}
```

### 5. Display Image Version in Status Command

**File:** `packages/cli-rust/src/commands/status.rs`

Add image version display after container info section:

```rust
use opencode_cloud_core::docker::{get_image_version, get_cli_version, VERSION_LABEL};

// ... after displaying container info ...

// Get and display versions
let cli_version = get_cli_version();
println!("{:>12} {}", style("CLI:").bold(), cli_version);

// Try to get image version from running container's image
if let Some(ref image) = info.config.and_then(|c| c.image) {
    if let Ok(Some(img_version)) = get_image_version(&client, image).await {
        if img_version != "dev" {
            println!("{:>12} {}", style("Image:").bold(), img_version);

            // Show warning if versions differ
            if cli_version != img_version {
                println!(
                    "{:>12} {}",
                    "",
                    style("(versions differ - consider pulling new image)").yellow().dim()
                );
            }
        }
    }
}
```

### 6. Add Version Display to --version Output

**File:** `packages/cli-rust/src/lib.rs`

Update the clap version display to be more informative:

```rust
#[command(version = concat!(env!("CARGO_PKG_VERSION"), " (CLI)"))]
```

This distinguishes CLI version in output.

## Verification

1. **Build without version label:**
   ```bash
   docker build -t opencode-cloud:test .
   occ status  # Should show CLI version only
   ```

2. **Build with version label:**
   ```bash
   docker build --build-arg OPENCODE_CLOUD_VERSION=1.0.7 -t opencode-cloud:test .
   occ start   # Should show version mismatch prompt
   ```

3. **Ignore version flag:**
   ```bash
   occ start --ignore-version  # Should skip check
   ```

4. **Status display:**
   ```bash
   occ status  # Should show both CLI and Image versions
   ```

## Dependencies

- Plan 14-01 (version label in Dockerfile)

## Outputs

- `packages/core/src/docker/version.rs` - New version detection module
- `packages/core/src/docker/mod.rs` - Export version module
- `packages/cli-rust/src/commands/start.rs` - Version check and --ignore-version flag
- `packages/cli-rust/src/commands/status.rs` - Version display

## Notes

### Graceful Degradation

Version check failures (network issues, Docker API errors) are non-fatal:
- Log warning if version check fails
- Continue with start operation
- Don't block user from running their container

### Local Builds

Locally built images (without version arg) have `dev` as version:
- Always treated as compatible
- No mismatch prompt for local builds
- Users who build from source are assumed to know what they're doing

### Pull vs Rebuild Decision

The prompt gives users clear choices:
- **Pull**: Fast, gets pre-built image with correct version
- **Rebuild**: Slow but uses latest Dockerfile from CLI
- **Continue**: For users who know what they're doing
