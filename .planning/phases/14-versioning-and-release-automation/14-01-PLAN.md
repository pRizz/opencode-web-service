# Plan 14-01: GitHub Actions Docker Build Workflow

## Objective

Create a GitHub Actions workflow that builds and publishes multi-arch Docker images to GHCR on release.

## Overview

Add `docker-publish.yml` workflow triggered by `release/v*` tags (same as publish.yml). The workflow uses buildx for multi-architecture support and pushes versioned images to ghcr.io/prizz/opencode-cloud.

## Prerequisites

- Phase 11 complete (current state)
- GHCR access configured (GitHub automatically provides `GITHUB_TOKEN`)

## Tasks

### 1. Add Version Label to Dockerfile

**File:** `packages/core/src/docker/Dockerfile`

Add version build arg and label after existing OCI labels (line ~63):

```dockerfile
# Version label - set at build time via --build-arg OPENCODE_CLOUD_VERSION=X.Y.Z
ARG OPENCODE_CLOUD_VERSION=dev
LABEL org.opencode-cloud.version="${OPENCODE_CLOUD_VERSION}"
```

Add version file near end of Dockerfile (before ENTRYPOINT/CMD):

```dockerfile
# Write version to file for runtime access
ARG OPENCODE_CLOUD_VERSION=dev
RUN echo "${OPENCODE_CLOUD_VERSION}" > /etc/opencode-cloud-version
```

Note: ARG must be repeated after FROM to be accessible in that stage.

### 2. Create Docker Publish Workflow

**File:** `.github/workflows/docker-publish.yml`

```yaml
name: Docker Publish

on:
  push:
    tags:
      - 'release/v*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ghcr.io/prizz/opencode-cloud

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write  # Required for GHCR push

    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          # Tag is release/vX.Y.Z, extract X.Y.Z
          VERSION="${GITHUB_REF_NAME#release/v}"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Building version: ${VERSION}"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Dockerfile from embedded location
        run: |
          # The Dockerfile is embedded in the Rust source
          cp packages/core/src/docker/Dockerfile .

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          build-args: |
            OPENCODE_CLOUD_VERSION=${{ steps.version.outputs.version }}
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}
            ${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
```

### 3. Update Dockerfile Label Placement

The ARG scope in multi-stage builds requires attention:
- ARG before first FROM: Available in all FROM instructions
- ARG after FROM: Only available in that stage

Since we have a multi-stage build (builder -> runtime), add ARG in runtime stage.

**Modify `packages/core/src/docker/Dockerfile`:**

After line 54 (`FROM ubuntu:24.04 AS runtime`), add:

```dockerfile
# Version passed at build time (after FROM to be available in this stage)
ARG OPENCODE_CLOUD_VERSION=dev
```

Modify OCI labels section (after line 63) to add version label:

```dockerfile
LABEL org.opencode-cloud.version="${OPENCODE_CLOUD_VERSION}"
```

Near end of file, before ENTRYPOINT, add:

```dockerfile
# Store version in file for runtime access
RUN echo "${OPENCODE_CLOUD_VERSION}" > /etc/opencode-cloud-version
```

## Verification

1. **Local test:** Build with version arg:
   ```bash
   docker build --build-arg OPENCODE_CLOUD_VERSION=1.0.8 \
     -t opencode-cloud:test -f packages/core/src/docker/Dockerfile .
   ```

2. **Check label:**
   ```bash
   docker inspect opencode-cloud:test --format '{{index .Config.Labels "org.opencode-cloud.version"}}'
   # Should output: 1.0.8
   ```

3. **Check version file:**
   ```bash
   docker run --rm opencode-cloud:test cat /etc/opencode-cloud-version
   # Should output: 1.0.8
   ```

4. **Push test:** Create test tag, verify workflow runs and image appears in GHCR.

## Dependencies

- None (first plan in phase)

## Outputs

- `.github/workflows/docker-publish.yml` - New workflow file
- `packages/core/src/docker/Dockerfile` - Modified with version label and file

## Notes

### Why QEMU for Multi-arch

Building ARM64 on x86_64 runners via QEMU is slower than native ARM runners but:
- Simpler workflow (single runner)
- No need to manage ARM runner availability
- Docker image build already takes ~15 min, QEMU overhead acceptable

### GitHub Actions Cache

Using GHA cache for Docker layers (`cache-from: type=gha`) speeds up subsequent builds. The cache is shared across workflow runs.

### Version File vs Label

Both version storage methods are provided:
- **Label:** Accessible via Docker API (used by CLI)
- **File:** Accessible inside running container (debugging, scripts)
