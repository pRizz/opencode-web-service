#cloud-config

# =============================================================================
# opencode-cloud AWS Quick Deploy (cloud-init)
# =============================================================================
# This script installs Docker, runs the opencode-cloud sandbox container, and
# creates an initial PAM user with a strong random password.
#
# CloudFormation substitutes the variables below when used as EC2 UserData.
# To run standalone, replace the ${...} values in /etc/opencode-cloud/stack.env.
# =============================================================================

package_update: true
package_upgrade: false
packages:
  - docker.io
  - curl
  - jq
  - build-essential
  - pkg-config
  - libssl-dev

write_files:
  - path: /etc/opencode-cloud/stack.env
    permissions: "0600"
    content: |
      OPENCODE_IMAGE=${OPENCODE_IMAGE}
      OPENCODE_CONTAINER_NAME=${OPENCODE_CONTAINER_NAME}
      OPENCODE_USERNAME=${OPENCODE_USERNAME}
      OPENCODE_DOMAIN_URL=${OPENCODE_DOMAIN_URL}
      OPENCODE_ALB_URL=${OPENCODE_ALB_URL}
      COCKPIT_DOMAIN_URL=${COCKPIT_DOMAIN_URL}
      COCKPIT_ALB_URL=${COCKPIT_ALB_URL}
  - path: /usr/local/bin/opencode-cloud-setup.sh
    permissions: "0755"
    content: |
      #!/usr/bin/env bash
      set -euo pipefail

      STATUS_DIR="/var/lib/opencode-cloud"
      STATUS_FILE="${STATUS_DIR}/deploy-status.json"
      PROVISIONED_FILE="${STATUS_DIR}/.provisioned"

      if [ -f "${PROVISIONED_FILE}" ]; then
        echo "opencode-cloud: already provisioned"
        exit 0
      fi

      mkdir -p "${STATUS_DIR}"
      chmod 700 "${STATUS_DIR}"

      # Load CloudFormation-provided values.
      if [ -f /etc/opencode-cloud/stack.env ]; then
        # shellcheck disable=SC1091
        source /etc/opencode-cloud/stack.env
      fi

      : "${OPENCODE_IMAGE:=ghcr.io/prizz/opencode-cloud-sandbox:latest}"
      : "${OPENCODE_CONTAINER_NAME:=opencode-cloud}"
      : "${OPENCODE_USERNAME:=opencode}"
      : "${OPENCODE_DOMAIN_URL:=}"
      : "${OPENCODE_ALB_URL:=}"
      : "${COCKPIT_DOMAIN_URL:=}"
      : "${COCKPIT_ALB_URL:=}"

      if ! command -v cargo >/dev/null 2>&1; then
        curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | \
          bash -s -- -y --profile minimal --default-toolchain 1.85.0
      fi

      export PATH="$HOME/.cargo/bin:${PATH}"

      if ! command -v opencode-cloud >/dev/null 2>&1; then
        cargo install opencode-cloud
      fi

      OPENCODE_CLI_VERSION="$(opencode-cloud --version 2>/dev/null || true)"

      systemctl enable --now docker

      docker pull "${OPENCODE_IMAGE}"

      docker volume create opencode-config >/dev/null
      docker volume create opencode-data >/dev/null
      docker volume create opencode-workspace >/dev/null

      if ! docker ps -a --format '{{.Names}}' | grep -qx "${OPENCODE_CONTAINER_NAME}"; then
        docker run -d \
          --name "${OPENCODE_CONTAINER_NAME}" \
          --restart unless-stopped \
          -p 3000:3000 \
          -p 3001:3001 \
          -p 3002:3002 \
          -p 9090:9090 \
          -v opencode-config:/home/opencode/.config \
          -v opencode-data:/home/opencode/.local/share \
          -v opencode-workspace:/home/opencode/workspace \
          "${OPENCODE_IMAGE}"
      fi

      # Wait for the container to be ready to accept commands.
      for _ in $(seq 1 30); do
        if docker exec "${OPENCODE_CONTAINER_NAME}" true >/dev/null 2>&1; then
          break
        fi
        sleep 2
      done

      if ! docker exec "${OPENCODE_CONTAINER_NAME}" id -u "${OPENCODE_USERNAME}" >/dev/null 2>&1; then
        docker exec "${OPENCODE_CONTAINER_NAME}" useradd -m -s /bin/bash "${OPENCODE_USERNAME}"
        docker exec "${OPENCODE_CONTAINER_NAME}" usermod -aG sudo "${OPENCODE_USERNAME}"
      fi

      OPENCODE_PASSWORD="$(tr -dc 'A-Za-z0-9' </dev/urandom | head -c 24)"
      echo "${OPENCODE_USERNAME}:${OPENCODE_PASSWORD}" | docker exec -i "${OPENCODE_CONTAINER_NAME}" chpasswd

      cat > "${STATUS_FILE}" <<EOF
      {
        "opencode_url": "${OPENCODE_DOMAIN_URL}",
        "opencode_alb_url": "${OPENCODE_ALB_URL}",
        "cockpit_url": "${COCKPIT_DOMAIN_URL}",
        "cockpit_alb_url": "${COCKPIT_ALB_URL}",
        "username": "${OPENCODE_USERNAME}",
        "password": "${OPENCODE_PASSWORD}",
        "container": "${OPENCODE_CONTAINER_NAME}",
        "image": "${OPENCODE_IMAGE}",
        "cli_version": "${OPENCODE_CLI_VERSION}"
      }
      EOF
      chmod 600 "${STATUS_FILE}"

      cat > /etc/motd <<EOF
      opencode-cloud ready.
      Username: ${OPENCODE_USERNAME}
      Password: ${OPENCODE_PASSWORD}
      opencode: ${OPENCODE_DOMAIN_URL}
      Cockpit: ${COCKPIT_DOMAIN_URL}
      Status file: ${STATUS_FILE}
      EOF

      date -u +"%Y-%m-%dT%H:%M:%SZ" > "${PROVISIONED_FILE}"

runcmd:
  - [bash, -lc, "/usr/local/bin/opencode-cloud-setup.sh"]
